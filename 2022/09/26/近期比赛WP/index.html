<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>近期比赛WP | Photon’s Blog</title><meta name="keywords" content="crypto,ctf"><meta name="author" content="Photon"><meta name="copyright" content="Photon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近攒了挺多比赛不会做的题没复现的，感觉过了一年自己还是那么菜…还是得多写代码多测试帮助理解 把这半个月打的CTF题复现一下,有些是做出来有些没做 .有意思的题我会详细整理一下 BalsnCTF 2022Yet another RSA with hint题长这样 12345678910111213141516171819202122from Crypto.Util.number import *f">
<meta property="og:type" content="article">
<meta property="og:title" content="近期比赛WP">
<meta property="og:url" content="http://phot0n.com/2022/09/26/%E8%BF%91%E6%9C%9F%E6%AF%94%E8%B5%9BWP/index.html">
<meta property="og:site_name" content="Photon’s Blog">
<meta property="og:description" content="最近攒了挺多比赛不会做的题没复现的，感觉过了一年自己还是那么菜…还是得多写代码多测试帮助理解 把这半个月打的CTF题复现一下,有些是做出来有些没做 .有意思的题我会详细整理一下 BalsnCTF 2022Yet another RSA with hint题长这样 12345678910111213141516171819202122from Crypto.Util.number import *f">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg">
<meta property="article:published_time" content="2022-09-26T02:30:36.000Z">
<meta property="article:modified_time" content="2022-10-07T13:55:38.367Z">
<meta property="article:author" content="Photon">
<meta property="article:tag" content="crypto">
<meta property="article:tag" content="ctf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg"><link rel="shortcut icon" href="/img/20170202211516_4B3nj.thumb.1000_0.jpeg"><link rel="canonical" href="http://phot0n.com/2022/09/26/%E8%BF%91%E6%9C%9F%E6%AF%94%E8%B5%9BWP/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '近期比赛WP',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-07 21:55:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"> <script src="/live2d-widget/autoload.js"></script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Photon’s Blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/01/19/K4TwFgDxsJ62tEo.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">62</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">41</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Photon’s Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">近期比赛WP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-09-26T02:30:36.000Z" title="Created 2022-09-26 10:30:36">2022-09-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-10-07T13:55:38.367Z" title="Updated 2022-10-07 21:55:38">2022-10-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">5.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>25min</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>最近攒了挺多比赛不会做的题没复现的，感觉过了一年自己还是那么菜…还是得多写代码多测试帮助理解</p>
<p>把这半个月打的CTF题复现一下,有些是做出来有些没做 .有意思的题我会详细整理一下</p>
<h1 id="BalsnCTF-2022"><a href="#BalsnCTF-2022" class="headerlink" title="BalsnCTF 2022"></a>BalsnCTF 2022</h1><h2 id="Yet-another-RSA-with-hint"><a href="#Yet-another-RSA-with-hint" class="headerlink" title="Yet another RSA with hint"></a>Yet another RSA with hint</h2><p>题长这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">p = getPrime(<span class="number">512</span>)</span><br><span class="line">q = getPrime(<span class="number">512</span>)</span><br><span class="line">n = p * q</span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">c = pow(bytes_to_long(flag), e, n)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">digitsSum</span>(<span class="params">n, base</span>):</span></span><br><span class="line">	ret = <span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> n:</span><br><span class="line">		ret += n % base</span><br><span class="line">		n //= base</span><br><span class="line">	<span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">hint = [digitsSum(p, i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">200</span>)]</span><br><span class="line"></span><br><span class="line">print(<span class="string">f&quot;<span class="subst">&#123;n = &#125;</span>&quot;</span>)</span><br><span class="line">print(<span class="string">f&quot;<span class="subst">&#123;e = &#125;</span>&quot;</span>)</span><br><span class="line">print(<span class="string">f&quot;<span class="subst">&#123;c = &#125;</span>&quot;</span>)</span><br><span class="line">print(<span class="string">f&quot;<span class="subst">&#123;hint = &#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>显然<code>digitsSum(n,base)</code>这个函数是求$n$ 的$base$ 进制数码和,记为$S_b(n)$ ,我们有如下关系式</p>
<script type="math/tex; mode=display">
n\equiv S_b(n) \mod (b-1)</script><p>这样我们根据$p$的数码和利用扩展中国剩余定理组合一下就能得到$p\mod(lcm(2,3,\dots,200))$ 的值,大概还差220比特,剩下的部分利用coppersmith求一下就行了</p>
<h2 id="VSS"><a href="#VSS" class="headerlink" title="VSS"></a>VSS</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> FLAG</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShareScheme</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, key: bytes</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> len(key) == <span class="number">128</span></span><br><span class="line">        self.key1 = bytes_to_long(key[:<span class="number">64</span>])</span><br><span class="line">        self.key2 = bytes_to_long(key[<span class="number">64</span>:])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getShare</span>(<span class="params">self</span>):</span></span><br><span class="line">        p = getPrime(<span class="number">512</span>)</span><br><span class="line">        a = random.randint(<span class="number">2</span>, p - <span class="number">1</span>)</span><br><span class="line">        b = random.randint(<span class="number">2</span>, p - <span class="number">1</span>)</span><br><span class="line">        c = random.randint(<span class="number">2</span>, p - <span class="number">1</span>)</span><br><span class="line">        y = (a + self.key1 * b + self.key2 * c) % p</span><br><span class="line">        <span class="keyword">return</span> p, a, b, c, y</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">commit</span>(<span class="params">val: int</span>):</span></span><br><span class="line">    p = getPrime(<span class="number">512</span>)</span><br><span class="line">    g = random.randint(<span class="number">2</span>, p - <span class="number">1</span>)</span><br><span class="line">    print(<span class="string">f&quot;Commitment: <span class="subst">&#123;p&#125;</span> <span class="subst">&#123;g&#125;</span> <span class="subst">&#123;pow(g, val, p)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">key = os.urandom(<span class="number">128</span>)</span><br><span class="line">ss = ShareScheme(key)</span><br><span class="line"></span><br><span class="line">real_key = sha256(key).digest()[:<span class="number">16</span>]</span><br><span class="line">cipher = AES.new(real_key, AES.MODE_ECB)</span><br><span class="line">enc_flag = cipher.encrypt(pad(FLAG, <span class="number">16</span>))</span><br><span class="line">print(<span class="string">f&quot;flag = <span class="subst">&#123;enc_flag.hex()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    op = int(input(<span class="string">&quot;Option: &quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> op == <span class="number">1</span>:</span><br><span class="line">        p, a, b, c, y = ss.getShare()</span><br><span class="line">        print(<span class="string">f&quot;<span class="subst">&#123;p = &#125;</span>&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;<span class="subst">&#123;a = &#125;</span>&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;<span class="subst">&#123;b = &#125;</span>&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;<span class="subst">&#123;c = &#125;</span>&quot;</span>)</span><br><span class="line">        commit(y)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>一道交互题,挺有意思的,从中也学到挺多的</p>
<p>题目大意是这样的,我们可以获得若干组如下满足</p>
<script type="math/tex; mode=display">
u_i\equiv a_i+x*b_i+y*c_i\mod p_i\\
v_i\equiv g_i^{u_i}\mod q_i</script><p>的数据$(p_i,a_i,b_i,c_i,q_i,g_i)$ </p>
<p>然后我们的目标就是恢复这个$(x,y)$ </p>
<p>主要的难点在于这个离散对数问题的求解.我当时一个朴素的想法是如果凑巧$q_i-1$是光滑数,那么我们显然可以通过PH算法求出$u_i$ 倘若我们能恢复两个这样的</p>
<p>$u_i$ ,那么直接解模方程就能解出$(x,y)$ .但是事实上这样很困难,因为很难生成这样一个光滑数</p>
<p>但是我们可以发现就算求不出完整的$u_i$,这个DLP形式的方程也能给我们一些信息,换句话说泄露某些比特.当我们收集到的信息足够多的时候,我们就有办法搞出这个$(x,y)$ </p>
<p>这里有一点借助PH思想的感觉,令</p>
<script type="math/tex; mode=display">
q_i-1 = p_1^{k_1}*p_2^{k_2}*\dots*p_l^{k_l}*S</script><p>(这里的$p_i$ 不是我们得到的模方程的$p_i$ ,就是$q_i-1$的素因子分解) 我们把$q_i-1$部分分解,把较小的素因子(大概小于$2^{24}$ )给提取出来,余下一个$S$ 是大素数因子的乘积</p>
<p>然后对方程进行变换,得到</p>
<script type="math/tex; mode=display">
v_i^{S} \equiv g_i^{S*u_i} \equiv G_i^{u_i} \mod q_i</script><p>这样我们就知道$G_i$模$q_i$的乘法群的阶为$p_1^{k_1}<em>p_2^{k_2}</em>\dots<em>p_l^{k_l}$ 是个光滑数(准确来说不是阶,而是阶整除这个数).记$\lambda_i = p_1^{k_1}</em>p_2^{k_2}<em>\dots</em>p_l^{k_l}$ 这样我们就能求出$u_i \mod \lambda_i$ ,也就是如下表达式</p>
<script type="math/tex; mode=display">
u_i\equiv a_i+x*b_i+y*c_i\mod p_i \mod \lambda_i \\
\rightarrow 0= a_i-u_i +x*b_i+y*c_i-p_i*s_i-\lambda_i*t_i</script><p>然后我们可以构造线性格来把$x,y$给规约出来</p>
<p>构造如下格子</p>
<script type="math/tex; mode=display">
A =\left[\begin{array}{ccccc:ccc:cccc}
a_1-u_1&a_2-u_2&a_3-u_3&\cdots&a_i-u_i&1&&&&\\
b_1&b_2&b_3&\cdots&b_i&&1&&&&\\
c_i&c_2&c_3&\cdots&c_i&&&1&&&&\\ \hdashline
-\lambda_1&&&&&&&&1\\
&-\lambda_2&&&&&&&&1\\
&&-\lambda_3&&&&&&&&1\\
&&&\ddots&&&&&&&&\ddots\\
&&&&-\lambda_i&&&&&&&&1\\ \hdashline
-p_1&&&\\
&-p_2&\\
&&-p_3&\\
&&&\ddots\\
&&&&-p_i\\
\end{array}\right]</script><p>令</p>
<script type="math/tex; mode=display">
v = \left[\begin{array} &1&x&y|t_1&t_2\dots&t_i|s_1&s_2&\dots&s_i\end{array}\right]</script><p>可以得到</p>
<script type="math/tex; mode=display">
v*A =\left[\begin{array} &0&0&\dots&0|1&x&y|t_i&t_2&\dots&t_i\end{array}\right]</script><p>为我们想求得的SVP</p>
<p>最后闲聊几句,由于我不太会用sage里面的<code>discrete_log</code>这类关于求离散对数的函数,不知道如何在已知$G_i$模$q_i$的乘法群的阶为光滑数的情况下快速求解(我试验了一下直接把$G_i$放进去好像还是很慢,不清楚内部实现(x)) 后来想一下自己也不是完全理解PH算法,还有BSGS算法(只会调库┭┮﹏┭┮),于是就自己花时间写了一下,顺便熟悉一下,大概是这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BSGS</span>(<span class="params">g,y,order,p</span>):</span></span><br><span class="line">    m = iroot(order,<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">not</span> m[<span class="number">1</span>]):</span><br><span class="line">        m = m[<span class="number">0</span>]+<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        m = m[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    g_inv = invert(g,p)</span><br><span class="line">    ANS = &#123;(y*powmod(g_inv, j, p)%p): j <span class="keyword">for</span> j <span class="keyword">in</span> range(m)&#125;</span><br><span class="line">    gs = powmod(g,m,p)</span><br><span class="line">    tmp  = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(m):</span><br><span class="line">        <span class="keyword">if</span>(tmp <span class="keyword">in</span> ANS):</span><br><span class="line">            <span class="keyword">return</span> i*m+ANS[tmp]</span><br><span class="line">        tmp = (tmp*gs)%p</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_fast_prime_list</span>(<span class="params">n</span>):</span> <span class="comment">#埃氏筛获取素数</span></span><br><span class="line">    s = [<span class="literal">True</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(n)]</span><br><span class="line">    ans = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,n):</span><br><span class="line">        <span class="keyword">if</span>(s[i]):</span><br><span class="line">            ans.append(i)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">2</span>*i,n,i):</span><br><span class="line">                s[j] = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> ans</span><br><span class="line">f = open(<span class="string">&quot;prime&quot;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">primelist = eval(f.read())</span><br><span class="line">f.close()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_part_fact</span>(<span class="params">p</span>):</span> <span class="comment">#get_part_dlp</span></span><br><span class="line">    pp = []</span><br><span class="line">    <span class="keyword">for</span> prime <span class="keyword">in</span> primelist:</span><br><span class="line">        <span class="keyword">if</span>(p%prime==<span class="number">0</span>):</span><br><span class="line">            times = <span class="number">1</span></span><br><span class="line">            p = p//prime</span><br><span class="line">            <span class="keyword">while</span>(p%prime==<span class="number">0</span>):</span><br><span class="line">                p = p//prime</span><br><span class="line">                times+=<span class="number">1</span></span><br><span class="line">            pp.append(prime**times)</span><br><span class="line">    <span class="keyword">return</span> pp,p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crt</span>(<span class="params">rem,mod</span>):</span></span><br><span class="line">    M = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> mod:</span><br><span class="line">        M*=i</span><br><span class="line">    Mm = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> mod:</span><br><span class="line">        Mm.append(M//i)</span><br><span class="line">    Mm_inv = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(Mm)):</span><br><span class="line">        Mm_inv.append(invert(Mm[i],mod[i]))</span><br><span class="line">    ans = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(mod)):</span><br><span class="line">        ans=(ans+(Mm[i]*Mm_inv[i]*rem[i]))%M</span><br><span class="line">    <span class="keyword">return</span> ans</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">part_DLP</span>(<span class="params">g,y,p</span>):</span> <span class="comment">#get_part_dlp</span></span><br><span class="line">    p_list,s = get_part_fact(p<span class="number">-1</span>)</span><br><span class="line">    ans = []</span><br><span class="line">    <span class="keyword">for</span> pp <span class="keyword">in</span> p_list:</span><br><span class="line">        ys = powmod(y,(p<span class="number">-1</span>)//pp,p)</span><br><span class="line">        gs = powmod(g,(p<span class="number">-1</span>)//pp,p)</span><br><span class="line">        ans.append(BSGS(gs,ys,pp,p))</span><br><span class="line">    <span class="keyword">return</span> crt(ans,p_list)</span><br><span class="line"></span><br><span class="line"><span class="comment">#test</span></span><br><span class="line"></span><br><span class="line">p = <span class="number">10030359293433381220565038851792910292586997578865776049984454625847367785507898175491437340922218643022138600864374969376681516033324932019365049501266797</span></span><br><span class="line">y = <span class="number">5496780498114072665179980513851803104893065180258905269720414193274422483013128888321549170222016387544751305685578896506367790690714036226767122037706232</span></span><br><span class="line">g = <span class="number">5344936366479577828422633940067093571002306215411960589794712947124041075230581692727951962855545803161471317824788568024245777175835445896026057474944535</span></span><br><span class="line">print(part_DLP(g,y,p))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>实现的<code>part_DLP</code>就是求得$x \mod p_1^{k_1}<em>p_2^{k_2}</em>\dots*p_l^{k_l}$ 的一个函数</p>
<p>LLL的代码没写,不过就是那样构造,把求得的$\lambda_i$还有各种参数填进去然后LLL应该就行了</p>
<p>题解参考的博客:<a href="[BalsnCTF 2022 Writeup :: Mystify (mystiz.hk">参考链接</a>](<a target="_blank" rel="noopener" href="https://mystiz.hk/posts/2022/2022-09-05-balsn/">https://mystiz.hk/posts/2022/2022-09-05-balsn/</a>))</p>
<h1 id="强网杯2022"><a href="#强网杯2022" class="headerlink" title="强网杯2022"></a>强网杯2022</h1><h2 id="Lattice"><a href="#Lattice" class="headerlink" title="Lattice"></a>Lattice</h2><p>说实话以前从来没接触过这个问题,比赛的时候搜到了论文是关于HSSP的,大概读懂了意思但是扩展一下调大范围不知道怎么改，正交格的问题还是第一次接触，这边稍微整理一下</p>
<p>先从HSSP问题说起，然后再扩展</p>
<h3 id="HSSP-PROBLEM"><a href="#HSSP-PROBLEM" class="headerlink" title="HSSP PROBLEM"></a>HSSP PROBLEM</h3><p>HSSP主要描述了这样一个问题，给定模数 $q$ ,一个向量$\vec{h} = (h_1,h_2,\dots,h_m) \in \mathbb{Z}^m$ 满足 </p>
<script type="math/tex; mode=display">
\vec{h} \equiv \alpha_1\vec{x_1}+\alpha_2\vec{x_2}+\dots+\alpha_n\vec{x_n} (\mod q)</script><p> 其中$\vec{\alpha} = (\alpha_1,\alpha_2,\dots,\alpha_n) \in \mathbb{Z_q}^n$ ，$\vec{x_i} \in\{0,1\}^m$ 然后让我们恢复出$\vec{\alpha},\vec{x_i}$</p>
<p>我们已知的量只有向量$\vec{h}$和$q$  。采用的方法是Nguyen-Stern算法，主要分为两步</p>
<ul>
<li>从向量$\vec{h}$ 构造出$\overline{\mathcal{L_x}}$ ,其中$\mathcal{L_x}$是向量$\vec{x_i}$ 张成的格</li>
<li>用BKZ算法从$\overline{\mathcal{L_x}}$  恢复出$\vec{x_i}$ 进而求解出$\vec{\alpha}$ </li>
</ul>
<p>首先说一下这个$\overline{\mathcal{L}}$ 是什么，我们假设有个格叫$\mathcal{L}$ ，有定义如下</p>
<script type="math/tex; mode=display">
\mathcal{L}(\mathcal{B}) = \{\sum_{i=1}^{k}v_i\vec{b_i}|v_1,\dots,v_k \in{\mathbb{Z}}\}</script><p>也就是由$\mathcal{B} = \{\vec{b_1},\dots,\vec{b_k}\}$ 张成的格空间，满足下式的称为其的正交格</p>
<script type="math/tex; mode=display">
\mathcal{L}^{\perp} = \{\vec{v} \in \mathbb{Z}^m|\forall\vec{b} \in\mathcal{L},<\vec{v},\vec{b}> =0  \}</script><p>然后$\overline{\mathcal{L}} =(\mathcal{L}^{\perp})^{\perp} $ 称为$\mathcal{L}$ 的<code>completion</code>(我也不知道怎么翻译)。可以知道$\mathcal{L}$为$\overline{\mathcal{L}}$的一个满秩子格。特别的，称格$\mathcal{L}$为完全的(<code>complete</code>)，当$\mathcal{L} = \overline{\mathcal{L}}$</p>
<h4 id="step-1-orthogonal-lattice-attack"><a href="#step-1-orthogonal-lattice-attack" class="headerlink" title="step 1:orthogonal lattice attack"></a>step 1:orthogonal lattice attack</h4><p>首先构造$\overline{\mathcal{L_x}}$  ，先取与$\vec{h}$模$q$正交的一系列向量</p>
<script type="math/tex; mode=display">
\mathcal{L}_0 = \{\vec{u} \in \mathbb{Z}^m|<\vec{u},\vec{h}>\equiv 0(\mod q)\}</script><p>所以我们带入显然可以知道这个向量是与$\alpha$ 模$q$正交的</p>
<script type="math/tex; mode=display">
\vec{P_u } = (<\vec{u_1},\vec{x_1}>,<\vec{u_2},\vec{x_2}>,\dots,<\vec{u_n},\vec{x_n}>)</script><p>因为</p>
<script type="math/tex; mode=display">
<\vec{u},\vec{h}> \equiv  \alpha_1<\vec{x_1},\vec{u_1}>+\alpha_2<\vec{x_2},\vec{u_2}>+\dots+\alpha_n<\vec{x_n},\vec{u_n} > \equiv 0 (\mod q)</script><p>这样如果$\vec{P_u } $ 比与$\alpha$ 模$q$正交的所有非零向量还要短，那么我们就肯定有$\vec{P_u } = 0$ ,这样的话就有$\vec{u} \in \mathcal{L}_x^{\perp}$  ，那么对$\mathcal{L}_0$ 进行LLL之后就能提取出$\mathcal{L}_x^{\perp}$ 的一组生成基，然后根据这些生成基再计算出$\overline{\mathcal{L}} =(\mathcal{L}^{\perp})^{\perp} $的一组基</p>
<p>那么问题来了，怎么构造这个$\mathcal{L}_0$ ,才能满足与$\vec{h}$ 模$q$正交 。我们将向量分隔成两部分，记$\vec{u} = (u_1,\vec{u’}),\vec{h} = (h_1,\vec{h’})$ 其中$\vec{u’},\vec{h’} \in{\mathbb{Z}^{m-1}}$ 也就是相当于分隔成一个数值部分和向量部分，那么我们就有</p>
<script type="math/tex; mode=display">
\begin{align}
\vec{u} \in \mathcal{L}_0 &\iff u_1*h_1+<\vec{u'},\vec{h'}> \equiv 0 (\mod q)\\
&\iff  u_1+<\vec{u'},\vec{h'}>*h_1^{-1}\equiv 0 (\mod q)
\end{align}</script><p>当然，前提是逆存在，然后这样构造格子(这里$[q]$应该是模q的意思)</p>
<script type="math/tex; mode=display">
\mathcal{L}_0 =\left[\begin{array}& q&\\-\vec{h'}*h_1^{-1}[q]&\textbf{I}_{m-1} \end{array}\right]</script><p>这是一个$m\times m$的矩阵，每一行为一个$u_i$ 显然对于所有的$u_i$都满足$u_1+&lt;\vec{u’},\vec{h’}&gt;<em>h_1^{-1}\equiv 0 (\mod q)$ 这个条件(第一行$u_1=q,\vec{u’} = 0$显然满足，第二行$u_1$为$-\vec{h’}</em>h_1^{-1}[q]$的第一个分量，而$\vec{u’} = (1,0\dots,0)$正好与$\vec{h’}$一内积就只剩第一个分量。后续同理)</p>
<p>那么构造的方法就如下代码所示</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">orthoLattice</span>(<span class="params">b, x0</span>):</span></span><br><span class="line">    m = b.length()</span><br><span class="line">    M = Matrix(ZZ, m, m)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, m):</span><br><span class="line">        M[i, i] = <span class="number">1</span></span><br><span class="line">    M[<span class="number">1</span>:m, <span class="number">0</span>] = -b[<span class="number">1</span>:m] * inverse_mod(b[<span class="number">0</span>], x0)</span><br><span class="line">    M[<span class="number">0</span>, <span class="number">0</span>] = x0</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, m):</span><br><span class="line">        M[i, <span class="number">0</span>] = mod(M[i, <span class="number">0</span>], x0)</span><br><span class="line">    <span class="keyword">return</span> M</span><br></pre></td></tr></table></figure>
<p>可以证明，对于充分大的$q$ ，我们对$\mathcal{L}_0$进行LLL的结果所得到的前$m-n$个向量$\vec{u_1},\dots,\vec{u}_{m-n}$ 是$\mathcal{L}_x^{\perp}$的一组生成基。证明过程就不贴了，我也没研究(x)</p>
<p>接下来就是用这组基再计算出$\overline{\mathcal{L}} =(\mathcal{L}^{\perp})^{\perp}$ 这里需要参考另外一篇论文，讲的是给定一个格$\mathcal{L}$ ，通过算法在多项式时间内计算出$\mathcal{L}^{\perp}$ 的一组LLL约减基。带到这里就是给定了$\mathcal{L}_x^{\perp}$  。这里就把算法贴下面了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kernelLLL</span>(<span class="params">M</span>):</span></span><br><span class="line">    n = M.nrows()</span><br><span class="line">    m = M.ncols()</span><br><span class="line">    <span class="keyword">if</span> m &lt; <span class="number">2</span> * n:</span><br><span class="line">        <span class="keyword">return</span> M.right_kernel().matrix()</span><br><span class="line">    K = <span class="number">2</span> ^ (m // <span class="number">2</span>) * M.height()</span><br><span class="line">    MB = Matrix(ZZ, m + n, m)</span><br><span class="line">    MB[:n] = K * M</span><br><span class="line">    MB[n:] = identity_matrix(m)</span><br><span class="line">    MB2 = MB.T.LLL().T</span><br><span class="line">    <span class="keyword">assert</span> MB2[:n, : m - n] == <span class="number">0</span></span><br><span class="line">    Ke = MB2[n:, : m - n].T</span><br><span class="line">    <span class="keyword">return</span> Ke</span><br></pre></td></tr></table></figure>
<p>那么至此我们就弄出了$\overline{\mathcal{L_x}}$ 的一组约减基，也就构造出了$\overline{\mathcal{L_x}}$ </p>
<h4 id="step-2-BKZ"><a href="#step-2-BKZ" class="headerlink" title="step 2:BKZ"></a>step 2:BKZ</h4><p>前面说到弄出了$\overline{\mathcal{L_x}}$ 的一组LLL约减基，但是由于LLL近似因子的原因,所得到的基可能会比$\vec{x_i}$大很多($\vec{x_i}\in\{0,1\}^m$)，所以需要进一步用BKZ算法来缩小近似因子，然后进而恢复出$\vec{x_i}$ 。这一块其实挺简单的，就对得到的格$\overline{\mathcal{L_x}}$不停加码进行BKZ操作就行了，直到得到的每个分量都$\in\{0,1\}$ </p>
<p>因为前面说到$\mathcal{L}$为$\overline{\mathcal{L}}$的一个满秩子格。所以对$\overline{\mathcal{L}}$进行格约简操作其实是能包括$\mathcal{L}$ ,得到后者的约简基的。不一定要求格是完全的</p>
<h3 id="强网杯中的TASK"><a href="#强网杯中的TASK" class="headerlink" title="强网杯中的TASK"></a>强网杯中的TASK</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.modules.free_module_integer <span class="keyword">import</span> IntegerLattice</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line">n = <span class="number">75</span></span><br><span class="line">m = <span class="number">150</span></span><br><span class="line">r = <span class="number">10</span></span><br><span class="line">N = <span class="number">126633165554229521438977290762059361297987250739820462036000284719563379254544315991201997343356439034674007770120263341747898897565056619503383631412169301973302667340133958109</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span>(<span class="params">n, m, r, N</span>):</span></span><br><span class="line">    t1 = [ZZ.random_element(<span class="number">-2</span>^<span class="number">15</span>, <span class="number">2</span>^<span class="number">15</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> range(n*m)]</span><br><span class="line">    t2 = [ZZ.random_element(N) <span class="keyword">for</span> _ <span class="keyword">in</span> range(r*n)]</span><br><span class="line">    B = matrix(ZZ, n, m, t1)</span><br><span class="line">    L = IntegerLattice(B)</span><br><span class="line">    A = matrix(ZZ, r, n, t2)</span><br><span class="line">    print(B)</span><br><span class="line">    C = (A * B) % N</span><br><span class="line">    <span class="keyword">return</span> L, C</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> s + (<span class="number">16</span> - len(s) % <span class="number">16</span>) * <span class="string">b&quot;\x00&quot;</span></span><br><span class="line"></span><br><span class="line">output = open(<span class="string">&quot;output.txt&quot;</span>,<span class="string">&quot;w&quot;</span>)</span><br><span class="line"><span class="comment">#token = input(&quot;team token:&quot;).strip().encode()</span></span><br><span class="line">L, C = gen(n, m, r, N)</span><br><span class="line">print(C,file = output)</span><br><span class="line">key = sha256(str(L.reduced_basis[<span class="number">0</span>]).encode()).digest()</span><br><span class="line">aes = AES.new(key, AES.MODE_ECB)</span><br><span class="line">ct = b64encode(aes.encrypt(pad(flag))).decode()</span><br><span class="line">print(ct,file = output)</span><br></pre></td></tr></table></figure>
<p>回顾刚刚关于HSSP问题的介绍，那个是长这样子的</p>
<script type="math/tex; mode=display">
\vec{h} \equiv \alpha_1\vec{x_1}+\alpha_2\vec{x_2}+\dots+\alpha_n\vec{x_n} (\mod q)</script><p>是只给一个向量，一个模数，并且每个$\vec{x_i}$的范围都是$\{0,1\}^m$ ,而其实这个TASK中的问题有所区别，它给的是</p>
<script type="math/tex; mode=display">
C\equiv A*B \mod N</script><p>并且每个$B$中的元素都在$(-2^{15},2^{15})$ 之间，是比$\vec{x_i}$的范围要大得多，但是也属于较小数的范畴。将矩阵用向量来表示，转化成一个类似HSSP的问题，其实就是相当于给定了</p>
<script type="math/tex; mode=display">
\vec{h_i} \equiv \alpha_{i,1}\vec{x_1}+\alpha_{i,2}\vec{x_2}+\dots+\alpha_{i,n}\vec{x_n} (\mod q)</script><p> 其中$i \in \{1,2,\dots,r\},\vec{x_i}\in\{-2^{15},\dots,2^{15}\}^m$ 可以发现区别是向量模长变大了，同时给了多组数据。我们要求出矩阵$B$构成的格的约简基的第一行。</p>
<p>一开始我想的是只使用一组数据，同时减少BKZ的次数以控制出来的约简基不至于太小，但是不太成功，就算只LLL一下出来的数据也特别小，根本不满足范围要求</p>
<p>这里我们需要对HSSP问题扩展一下，那里我们构造的是一个$\mathcal{L_0}$ ,满足模$q$正交，也即</p>
<script type="math/tex; mode=display">
\mathcal{L}_0 = \{\vec{u} \in \mathbb{Z}^m|<\vec{u},\vec{h}>\equiv 0(\mod q)\}</script><p>然后我们知道它LLL的结果所得到的前$m-n$个向量$\vec{u_1},\dots,\vec{u}_{m-n}$ 是$\mathcal{L}_x^{\perp}$的一组生成基，随即用<code>kernelLLL</code>对其操作得到$\overline{\mathcal{L_x}}$，由于$\mathcal{L_x}$是$\overline{\mathcal{L_x}}$的一个满秩子格，所以对后者不断进行BKZ就行了</p>
<p>这里我们也需要构造一个模$p$正交的格，但是由于给了多组数据，所以我们扩展一下，类似的，相当于需要构造一个$\mathcal{L_0’}$,满足如下表达式</p>
<script type="math/tex; mode=display">
\mathcal{L}_0 = \{\vec{u} \in \mathbb{Z}^m|\forall i\in\{1,\dots,r\},<\vec{u},\vec{h_i}>\equiv 0(\mod q)\}</script><p>将$h_i$向量构成的矩阵记作$C$ ，相当于我们需要找到一个$B’$ ，满足</p>
<script type="math/tex; mode=display">
B'*C^{T}\equiv0(\mod q)</script><p>在HSSP问题中，我们采取的方法是构造，这里我没试过能否构造，先贴一下Nu1L的思路分析一下(侵删)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">A = matrix(ZZ,m+r,m+r)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(m):</span><br><span class="line">	A[i,i] = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(r):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(m):</span><br><span class="line">		A[j,i+m] = C[i,j]&lt;&lt;<span class="number">200</span></span><br><span class="line">	A[i+m,i+m] = N&lt;&lt;<span class="number">200</span></span><br><span class="line">ans = A.LLL()</span><br><span class="line">B = matrix(ZZ,n,m)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">	<span class="keyword">assert</span> list(ans[i][m:]) == [<span class="number">0</span>]*r</span><br><span class="line">	B[i] = ans[i][:m]</span><br></pre></td></tr></table></figure>
<p>这里后来我测试的时候发现是满足上面那个关系式的，测试的主要代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">&#x27;output.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">  data = f.readlines()</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">    data[i] = data[i].replace(<span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    tmp = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> data[i]:</span><br><span class="line">      <span class="keyword">if</span> x != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        tmp.append(int(x))</span><br><span class="line">    data[i] = tmp</span><br><span class="line">C = matrix(ZZ, data)</span><br><span class="line"></span><br><span class="line">B = matrix(ZZ,n,m)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">  <span class="keyword">assert</span> list(ans[i][m:]) == [<span class="number">0</span>]*r</span><br><span class="line">  B[i] = ans[i][:m]</span><br><span class="line">print(<span class="string">&quot;may be (B*C^T) mod N = 0&quot;</span>)</span><br><span class="line">print((B*C.transpose())%N)</span><br><span class="line">print(<span class="string">&quot;=&quot;</span>*<span class="number">150</span>)</span><br></pre></td></tr></table></figure>
<p>测试的结果如下图，确实是满足正交的一个矩阵</p>
<p><img src="https://s2.loli.net/2022/09/30/J4Za7moPY5Vzu9E.png" alt="QQ图片20220930151217.png"></p>
<p>我个人的理解是这样的,改写表达式为</p>
<script type="math/tex; mode=display">
C\equiv A*B \mod N \rightarrow C =A*B-N*P \rightarrow C^{T} = B^{T}*A^{T}-N*P^{T}</script><p>其中$P$是一个随机矩阵。当构造如下格</p>
<script type="math/tex; mode=display">
A =\left[\begin{array}{c:c}
\textbf{I}_m&C^{T}*2^{200}\\ \hdashline
\textbf{0}&N*\textbf{I}_r*2^{200}
\end{array}\right]</script><p>对其进行LLL的时候，相当于我们在寻求一个矩阵$S$，使得$S*A$得到短基，这个矩阵大致刻画一下是这样的</p>
<script type="math/tex; mode=display">
S =\left[\begin{array}{c:c}
B'&K\\ \hdashline
\textbf{?}&\textbf{?}
\end{array}\right]</script><p>我们只关注上半行的右半边，由于加了一个权重2^200，我们所以右半r边大概率是0，否则模长至少为2^200这个量级(从右半边而言)</p>
<p>那么其实就相当于满足了这个东西</p>
<script type="math/tex; mode=display">
B'*C^{T}+N*K= 0</script><p>两边模去$N$,显然有</p>
<script type="math/tex; mode=display">
B'*C^{T}\equiv0(\mod N)</script><p>模仿HSSP的思路，得到了$B’$ 之后，我们对其进行<code>kernelLLL</code>得到$\overline{\mathcal{L_x}}$ 也就是我们原始的B的一组LLL约简基，但是这里有个问题是似乎比例因子不太对，得到的元素都是并不在$\{-2^{15},\dots,2^{15}\}^m$ 范围，而是略大一点，所以用BKZ进一步约简即可</p>
<p>当然我们也可以不用<code>kernelLLL</code> ，而是直接<code>right_kernel().basis()</code> ，因为我们之前说过得到的是$\mathcal{L}_x^{\perp}$的一组生成基，那么对其再取个右核其实就一点类似于求正交格的过程(事实上<code>kernelLLL</code>有一步判断$m&lt;2n$的 时候也就是这样做的)。本地测试了一下，无论是<code>kernelLLL</code>zai再BKZ还是<code>right_kernel().basis()</code>再BKZ，都能得到正确的答案</p>
<p>生成数据的测试代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.modules.free_module_integer <span class="keyword">import</span> IntegerLattice</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line">n = <span class="number">75</span></span><br><span class="line">m = <span class="number">150</span></span><br><span class="line">r = <span class="number">10</span></span><br><span class="line">N = <span class="number">126633165554229521438977290762059361297987250739820462036000284719563379254544315991201997343356439034674007770120263341747898897565056619503383631412169301973302667340133958109</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span>(<span class="params">n, m, r, N</span>):</span></span><br><span class="line">    t1 = [ZZ.random_element(<span class="number">-2</span>^<span class="number">15</span>, <span class="number">2</span>^<span class="number">15</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> range(n*m)]</span><br><span class="line">    t2 = [ZZ.random_element(N) <span class="keyword">for</span> _ <span class="keyword">in</span> range(r*n)]</span><br><span class="line">    B = matrix(ZZ, n, m, t1)</span><br><span class="line">    L = IntegerLattice(B)</span><br><span class="line">    A = matrix(ZZ, r, n, t2)</span><br><span class="line">    save(B,<span class="string">&#x27;orignal_b.sobj&#x27;</span>)</span><br><span class="line">    C = (A * B) % N</span><br><span class="line">    <span class="keyword">return</span> L,B, C</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> s + (<span class="number">16</span> - len(s) % <span class="number">16</span>) * <span class="string">b&quot;\x00&quot;</span></span><br><span class="line"></span><br><span class="line">output = open(<span class="string">&quot;output.txt&quot;</span>,<span class="string">&quot;w&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#token = input(&quot;team token:&quot;).strip().encode()</span></span><br><span class="line">L, B,C = gen(n, m, r, N)</span><br><span class="line">print(C,file = output)</span><br><span class="line">save(C,<span class="string">&quot;output.sobj&quot;</span>)</span><br><span class="line">save(L,<span class="string">&quot;L.sobj&quot;</span>)</span><br><span class="line">LL = load(<span class="string">&quot;L.sobj&quot;</span>)</span><br><span class="line">print(LL==L)</span><br><span class="line">CC = load(<span class="string">&quot;output.sobj&quot;</span>)</span><br><span class="line">print(CC==C)</span><br><span class="line">OB = load(<span class="string">&quot;orignal_b.sobj&quot;</span>)</span><br><span class="line">print(OB==B)</span><br></pre></td></tr></table></figure>
<p>进行测试的代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">n = <span class="number">75</span></span><br><span class="line">m = <span class="number">150</span></span><br><span class="line">r = <span class="number">10</span></span><br><span class="line">N =<span class="number">126633165554229521438977290762059361297987250739820462036000284719563379254544315991201997343356439034674007770120263341747898897565056619503383631412169301973302667340133958109</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kernelLLL</span>(<span class="params">M</span>):</span></span><br><span class="line">    n = M.nrows()</span><br><span class="line">    m = M.ncols()</span><br><span class="line">    <span class="keyword">if</span> m &lt; <span class="number">2</span> * n:</span><br><span class="line">        <span class="keyword">return</span> M.right_kernel().matrix()</span><br><span class="line">    K = <span class="number">2</span> ^ (m // <span class="number">2</span>) * M.height()</span><br><span class="line">    MB = Matrix(ZZ, m + n, m)</span><br><span class="line">    MB[:n] = K * M</span><br><span class="line">    MB[n:] = identity_matrix(m)</span><br><span class="line">    MB2 = MB.T.LLL().T</span><br><span class="line">    <span class="keyword">assert</span> MB2[:n, : m - n] == <span class="number">0</span></span><br><span class="line">    Ke = MB2[n:, : m - n].T</span><br><span class="line">    <span class="keyword">return</span> Ke</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&#x27;output.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">  data = f.readlines()</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">    data[i] = data[i].replace(<span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;&#x27;</span>).split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    tmp = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> data[i]:</span><br><span class="line">      <span class="keyword">if</span> x != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        tmp.append(int(x))</span><br><span class="line">    data[i] = tmp</span><br><span class="line">C = matrix(ZZ, data)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">CC = load(&quot;output.sobj&quot;)</span></span><br><span class="line"><span class="string">print(C==CC)</span></span><br><span class="line"><span class="string">A = matrix(ZZ,m+r,m+r)</span></span><br><span class="line"><span class="string">for i in range(m):</span></span><br><span class="line"><span class="string">  A[i,i] = 1</span></span><br><span class="line"><span class="string">for i in range(r):</span></span><br><span class="line"><span class="string">  for j in range(m):</span></span><br><span class="line"><span class="string">    A[j,i+m] = C[i,j]&lt;&lt;200</span></span><br><span class="line"><span class="string">  A[i+m,i+m] = N&lt;&lt;200</span></span><br><span class="line"><span class="string">print(&quot;start LLL&quot;)</span></span><br><span class="line"><span class="string">ans = A.LLL()</span></span><br><span class="line"><span class="string">print(&quot;END LLL&quot;)</span></span><br><span class="line"><span class="string">save(ans,&quot;ALLL.sobj&quot;)</span></span><br><span class="line"><span class="string">B = matrix(ZZ,n,m)</span></span><br><span class="line"><span class="string">for i in range(n):</span></span><br><span class="line"><span class="string">  assert list(ans[i][m:]) == [0]*r</span></span><br><span class="line"><span class="string">  B[i] = ans[i][:m]</span></span><br><span class="line"><span class="string">ans = B.right_kernel().basis()</span></span><br><span class="line"><span class="string">save(ans,&quot;ans.sobj&quot;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">ans = load(<span class="string">&quot;ALLL.sobj&quot;</span>)</span><br><span class="line"></span><br><span class="line">B = matrix(ZZ,n,m)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">  <span class="keyword">assert</span> list(ans[i][m:]) == [<span class="number">0</span>]*r</span><br><span class="line">  B[i] = ans[i][:m]</span><br><span class="line">print(<span class="string">&quot;may be (B*C^T) mod N = 0&quot;</span>)</span><br><span class="line">print((B*C.transpose())%N)</span><br><span class="line">print(<span class="string">&quot;=&quot;</span>*<span class="number">150</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ke = kernelLLL(B)</span><br><span class="line">print(<span class="string">&quot;This is the kernelLLL of B&quot;</span>)</span><br><span class="line">print(ke[<span class="number">0</span>])</span><br><span class="line">print(<span class="string">&quot;=&quot;</span>*<span class="number">150</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;This is BKZ(block_size=12) of the kernelLLL of B&quot;</span>)</span><br><span class="line">print(kernelLLL(B).BKZ(block_size=<span class="number">12</span>)[<span class="number">0</span>])</span><br><span class="line">print(<span class="string">&quot;=&quot;</span>*<span class="number">150</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;This is LLLof the kernelLLL of B&quot;</span>)</span><br><span class="line">print(kernelLLL(B).LLL()[<span class="number">0</span>])</span><br><span class="line">print(<span class="string">&quot;=&quot;</span>*<span class="number">150</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;This is the BKZ of right_kernel basis of B&quot;</span>)</span><br><span class="line">ans = load(<span class="string">&quot;ans.sobj&quot;</span>)</span><br><span class="line">D = matrix(ZZ,ans)</span><br><span class="line">res = D.BKZ(block_size=<span class="number">12</span>)[<span class="number">0</span>]</span><br><span class="line">print(res)</span><br><span class="line">print(<span class="string">&quot;=&quot;</span>*<span class="number">150</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;This is the LLL of right_kernel basis of B&quot;</span>)</span><br><span class="line">res = D.LLL()[<span class="number">0</span>]</span><br><span class="line">print(res)</span><br><span class="line">print(<span class="string">&quot;=&quot;</span>*<span class="number">150</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OB = load(<span class="string">&quot;orignal_b.sobj&quot;</span>)</span><br><span class="line">print(<span class="string">&quot;This is the answer we search for&quot;</span>)</span><br><span class="line">print(OB.LLL()[<span class="number">0</span>])</span><br><span class="line">print(<span class="string">&quot;=&quot;</span>*<span class="number">150</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以观察<code>kernelLLL</code>的LLL以及BKZ结果，以及直接<code>right_kernel().basis()</code>的LLL以及BKZ结果，和我们想要的正确答案之间的比对，截图如下</p>
<p><img src="https://s2.loli.net/2022/09/30/HMpo1QwCjcqEBWP.png" alt="测试"> </p>
<h2 id="残余问题"><a href="#残余问题" class="headerlink" title="残余问题"></a>残余问题</h2><p>我们是通过LLL求得$\mathcal{L_0}$ 的，而不是论文当中的构造方法，能否通过构造来得到$\mathcal{L_0}$ </p>
<p>回头有空再研究一下吧(🕊)</p>
<p>这个只是N-S算法的一个扩展，好像论文里面采用的是统计的方法来得到的，查到的还有利用傅里叶变换来求解的。不过似乎都挺复杂的</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="[Provably Solving the Hidden Subset Sum Problem via Statistical Learning (iacr.org">Provably Solving the Hidden Subset Sum Problem via Statistical Learning</a>](<a target="_blank" rel="noopener" href="https://eprint.iacr.org/2021/1007">https://eprint.iacr.org/2021/1007</a>)) </p>
<h1 id="TCTF-0CTF-2022"><a href="#TCTF-0CTF-2022" class="headerlink" title="TCTF/0CTF 2022"></a>TCTF/0CTF 2022</h1><h2 id="ezvm"><a href="#ezvm" class="headerlink" title="ezvm"></a>ezvm</h2><p>一道虚拟机pwn题，第一次遇见。嗯。。。显然不会做，不过后来看了大佬的博客看懂了漏洞点以及利用方式。</p>
<p>主要是一个因为整数溢出导致的越界写</p>
<p><img src="https://s2.loli.net/2022/10/07/uNcymtHjgvsB7h8.png" alt="hole"></p>
<p>虚拟机初始化了三个内存区域:代码、内存、栈。其中代码区域和内存区域的大小是我们可以指定的，但是有相应限制，代码区域小于<code>0x200</code>,内存区域大于<code>0x200000000000000</code>的只能申请一次。而且其实可以发现内存区域并不是我们要求多少就申请多少，而是申请了<code>8*memory_size</code> ，相当于左移了三位。那么假如申请<code>0x2000000000000001</code>的内存，其实事实上申请的是<code>0x1000</code>大小的内存(因为高位左移之后溢出了)</p>
<p><img src="https://s2.loli.net/2022/10/07/iYdBa3pksfJOPVc.png" alt=""></p>
<p>在这里通过代码21就能把实现的寄存器上的值写入到内存区</p>
<p>还有一个注意的点就是，如果我们想<code>malloc</code>一个超过<code>0x21000</code>的内存，就会通过<code>mmap</code>来申请，这个方式申请的区域在内存上是与<code>libc</code>相邻的。</p>
<p>所以通过越界写就能修改<code>libc</code>中的很多东西</p>
<p>有了越界写之后当然我们还想泄露一下<code>libc</code>基址，但是这里其实是不能越界读的，因为仔细观察代码22发现他的限制是<code>8*mem_size/8</code>这样就相当于和溢出了的情况是一样的。</p>
<p>这里主要是利用了一种类似于侧信道攻击的方法。显然我们的想法是把<code>unsortedbin</code>上那个与<code>main_arena</code>相关的地址给泄露，然后就能顺理成章拿到<code>libc</code>的基址。当我们申请内存区把一个放入<code>unsortedbin</code>的堆块申请回来时，这个地址是还存在的。所以我们可以通过 操作内存的一些操作，通过逐位与，来把内存区中的字节都泄露出来，这样就把这个<code>main_arena</code>地址给搞到手了</p>
<p>具体的做法是利用遇到无法识别的的<code>opcode</code>就输出<code>what???</code>这个字符。先把内存区的相应字节置入寄存器0，然后把进行测试的mask(也就是1&lt;&lt;i)放入寄存器1，利用逻辑与的<code>opcode</code>进行比较，测试的结果放入到了实现的<code>result</code>寄存器,然后利用<code>opcode=16</code>这个跳转，通过跳转得到的输出是否有<code>what</code>来判断这个位到底是1还是0。</p>
<p>泄露出来之后，结合越界写就能进行一系列<code>FSOP</code>或者其他针对<code>exit</code>的一些攻击(因为程序中其实是显式调用了<code>exit</code>的)</p>
<p>这里学到一个就是利用<code>call_tls_dtors()</code>进行getshell的方法(house_of_emma利用的好像也是这个，突然想起来上次那篇博客还没更🕊,找个时间把上次那个博客更一下)。具体的原理只研究了大概。不过这个有个要求就是需要修改或者泄露<code>fs:0x30</code>这个地方的值。这个好像是是对调用的函数指针进行加密的一种安全措施。具体加密方式主要就是简单异或。<code>fs:0x30</code>这个位置其实好像是在TLS段上，位于与 libc 相邻的 ld 空间中，这个位置距离 libc 地址的偏移固定。所以我们可以选择本地起一个docker拉下来看偏移就行了</p>
<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Photon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://phot0n.com/2022/09/26/%E8%BF%91%E6%9C%9F%E6%AF%94%E8%B5%9BWP/">http://phot0n.com/2022/09/26/%E8%BF%91%E6%9C%9F%E6%AF%94%E8%B5%9BWP/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/crypto/">crypto</a><a class="post-meta__tags" href="/tags/ctf/">ctf</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/11/07/%E7%A5%A5%E4%BA%91%E6%9D%AF2022wp/"><img class="prev-cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">祥云杯2022wp</div></div></a></div><div class="next-post pull-right"><a href="/2022/09/06/%E9%AB%98%E7%89%88%E6%9C%AC%E7%9A%84%E5%A0%86%E5%88%A9%E7%94%A8%E4%B8%8EFSOP/"><img class="next-cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">高版本的堆利用与FSOP</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/01/02/CatCTF2022/" title="CatCTF2022"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-02</div><div class="title">CatCTF2022</div></div></a></div><div><a href="/2022/08/31/WMctf2022/" title="WMctf2022"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">WMctf2022</div></div></a></div><div><a href="/2022/11/19/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812022/" title="强网拟态2022"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-19</div><div class="title">强网拟态2022</div></div></a></div><div><a href="/2022/11/07/%E7%A5%A5%E4%BA%91%E6%9D%AF2022wp/" title="祥云杯2022wp"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-07</div><div class="title">祥云杯2022wp</div></div></a></div><div><a href="/2022/05/08/%E5%BC%82%E5%B8%B8%E6%9B%B2%E7%BA%BF%E6%94%BB%E5%87%BB/" title="异常曲线攻击"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-08</div><div class="title">异常曲线攻击</div></div></a></div><div><a href="/2022/04/30/MRCTF2022/" title="MRCTF2022"><img class="cover" src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-30</div><div class="title">MRCTF2022</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2022/01/19/K4TwFgDxsJ62tEo.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Photon</div><div class="author-info__description">光子</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">62</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">41</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/photonwork"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/photonwork" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BalsnCTF-2022"><span class="toc-number">1.</span> <span class="toc-text">BalsnCTF 2022</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Yet-another-RSA-with-hint"><span class="toc-number">1.1.</span> <span class="toc-text">Yet another RSA with hint</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VSS"><span class="toc-number">1.2.</span> <span class="toc-text">VSS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF2022"><span class="toc-number">2.</span> <span class="toc-text">强网杯2022</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lattice"><span class="toc-number">2.1.</span> <span class="toc-text">Lattice</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HSSP-PROBLEM"><span class="toc-number">2.1.1.</span> <span class="toc-text">HSSP PROBLEM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#step-1-orthogonal-lattice-attack"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">step 1:orthogonal lattice attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#step-2-BKZ"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">step 2:BKZ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF%E4%B8%AD%E7%9A%84TASK"><span class="toc-number">2.1.2.</span> <span class="toc-text">强网杯中的TASK</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AE%8B%E4%BD%99%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.</span> <span class="toc-text">残余问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">2.3.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TCTF-0CTF-2022"><span class="toc-number">3.</span> <span class="toc-text">TCTF&#x2F;0CTF 2022</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ezvm"><span class="toc-number">3.1.</span> <span class="toc-text">ezvm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babyheap"><span class="toc-number">3.2.</span> <span class="toc-text">babyheap</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/08/29/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/" title="算法学习"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="算法学习"/></a><div class="content"><a class="title" href="/2024/08/29/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/" title="算法学习">算法学习</a><time datetime="2024-08-29T11:34:52.000Z" title="Created 2024-08-29 19:34:52">2024-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/31/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="深度学习记录"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深度学习记录"/></a><div class="content"><a class="title" href="/2024/07/31/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="深度学习记录">深度学习记录</a><time datetime="2024-07-31T06:57:07.000Z" title="Created 2024-07-31 14:57:07">2024-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/29/SICP%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" title="SICP读书笔记"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SICP读书笔记"/></a><div class="content"><a class="title" href="/2024/07/29/SICP%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" title="SICP读书笔记">SICP读书笔记</a><time datetime="2024-07-29T03:22:55.000Z" title="Created 2024-07-29 11:22:55">2024-07-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/06/wsl2%E4%B8%8Evscode%E4%B8%8Brust%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" title="wsl2与vscode下rust开发环境配置"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="wsl2与vscode下rust开发环境配置"/></a><div class="content"><a class="title" href="/2024/07/06/wsl2%E4%B8%8Evscode%E4%B8%8Brust%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" title="wsl2与vscode下rust开发环境配置">wsl2与vscode下rust开发环境配置</a><time datetime="2024-07-06T06:56:26.000Z" title="Created 2024-07-06 14:56:26">2024-07-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/04/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" title="java动态代理"><img src="https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="java动态代理"/></a><div class="content"><a class="title" href="/2024/07/04/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" title="java动态代理">java动态代理</a><time datetime="2024-07-04T10:32:27.000Z" title="Created 2024-07-04 18:32:27">2024-07-04</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://i.loli.net/2021/10/14/GSfj5BxXTdRqg2o.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2026 By Photon</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><br>
<img src="https://static.dy208.cn/o_1dfilp8ruo521thr1hvf18ji17soa.png">
<a href="https://beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">皖ICP备2022000759号</a></div><div class="footer_custom_text">欢迎来到光子的博客哟(●'◡'●)</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'J3nDf4qkr8OdRFaP64k2k453-gzGzoHsz',
      appKey: 'NXx6F7OYpwVWFbIQPVnw8HvN',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"live2d-widget-model-haruto"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>